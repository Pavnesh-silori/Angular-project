<div class="card main-card cardOverwrite h100">
    <div class="headerContainer">
        <div class="headerLeftContainer">
            <div class="pageTitle">{{ action == FormAction.CREATE ? PageTitleEnum.CREATE : PageTitleEnum.UPDATE }} {{ alertLabel
                }} Alert Rule</div>
        </div>
    </div>

    <div class="card-body">
        <form [formGroup]="alertRuleFG">
            <div class="row">
                <div class="col-sm-12">
                    <mat-card class="border cardOverwrite">
                        <div class="cardTitle">
                            Alert On
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label class="formLabel"> Alert name </mat-label>
                                    <input class="formPlaceholder" matInput type="text" placeholder="Alert name" formControlName="name"
                                        required>
                                    <mat-error *ngIf="errorHandling('name', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-6">
                                <lib-parameter #parameterFilterChild></lib-parameter>
                            </div>
                        </div>

                        <div class="row mt-1" *ngIf="alertRuleFG.get('parameterID').value">
                            <div class="col-sm-12">
                                <mat-accordion>
                                    <mat-expansion-panel class="matAccordion" [expanded]="isEntityPanelExpanded" (opened)="entityPanelOpened()"
                                        (closed)="entityPanelClosed()">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                <div class="card-title sectionTitle">
                                                    Select entity *
                                                </div>
                                                <div class="row ms-2">
                                                    <mat-error class="entityError"
                                                        *ngIf="isFormSubmit && !isEntityPanelExpanded && errorHandling('entityID', 'required')">
                                                        {{ FormErrorEnum.REQUIRED }}
                                                    </mat-error>
                                                </div>
                                            </mat-panel-title>
                                        </mat-expansion-panel-header>
                                        <div class="row">
                                            <div class="mb-3">
                                                <small class="pageSubtitle">
                                                    <span *ngIf="alertLabel == AlertTypeLabelEnum.INSTANTANEOUS_LABEL">
                                                        Choose <span class="text-secondary fw-bold">
                                                            'Select all sub-entities'
                                                        </span> to generate alert at the current selection and any future entities
                                                        at that level.
                                                    </span> </small>
                                                <br />
                                                <small class="pageSubtitle">
                                                    <span class="text-secondary fw-bold">NOTE: </span> The parameter you've selected is not present in the entities
                                                    highlighted in <span class="fw-bold"> gray.</span>
                                                </small>
                                            </div>
                                            <div *ngFor="let entity of entityM; let i = index" class="mt-2">
                                                <mat-checkbox [ngClass]="{'text-secondary': !entity.isParameterExists}" [checked]="isSelected(entity.id)"
                                                    (change)="entityChange(entity.id, $event)">
                                                    {{ entity.name }}
                                                </mat-checkbox>
                                                <span class="ms-5"
                                                    *ngIf="alertLabel == AlertTypeLabelEnum.INSTANTANEOUS_LABEL && alertRuleFG.get('entityID').value && alertRuleFG.get('entityID').value.length > 0">
                                                    <mat-checkbox formControlName="isSubEntitiesSelected" (change)="selectAllSubEntities($event)">
                                                        Select all sub-entities
                                                    </mat-checkbox>
                                                </span>
                                                <div *ngIf="entity.children && entity.children.length > 0" class="ms-5">
                                                    <ng-container *ngTemplateOutlet="recursiveTemplate; context:{ $implicit: entity.children }"></ng-container>
                                                </div>
                                            </div>
                                            <ng-template #recursiveTemplate let-entities>
                                                <div *ngFor="let entity of entities; let i = index" class="mt-2">
                                                    <mat-checkbox [ngClass]="{'text-secondary': !entity.isParameterExists}" [checked]="isSelected(entity.id)"
                                                        (change)="entityChange(entity.id, $event)">
                                                        {{ entity.name }}
                                                    </mat-checkbox>
                                                    <div *ngIf="entity.children && entity.children.length > 0" class="ms-5">
                                                        <ng-container *ngTemplateOutlet="recursiveTemplate; context:{ $implicit: entity.children }"></ng-container>
                                                    </div>
                                                </div>
                                            </ng-template>
                                        </div>
                                        <mat-error class="entityError"
                                            *ngIf="isFormSubmit && isEntityPanelExpanded && errorHandling('entityID', 'required')">
                                            <br />{{ FormErrorEnum.REQUIRED }}
                                        </mat-error>
                                    </mat-expansion-panel>
                                </mat-accordion>
                            </div>
                        </div>

                        <div *ngIf="alertLabel == AlertTypeLabelEnum.INSTANTANEOUS_LABEL && alertRuleFG.get('entityID').value && alertRuleFG.get('entityID').value.length > 0">
                            <div class="row mt-4">
                                <div class="col-sm-6">
                                    <div class="radioBtnField">
                                        <div class="radioBtnGroupLabel"> Would you prefer to receive alerts at device
                                            level? </div>
                                        <mat-radio-group formControlName="isAlertAtDeviceLevel">
                                            <div class="row my-1">
                                                <div class="col-sm-6">
                                                    <mat-radio-button class="radioBtnLabel" [value]="true">
                                                        Yes
                                                    </mat-radio-button>
                                                </div>
                                                <div class="col-sm-6">
                                                    <mat-radio-button class="radioBtnLabel" [value]="false">
                                                        No
                                                    </mat-radio-button>
                                                </div>
                                                <mat-error class="radioBtnGroupError ms-1 mt-1" *ngIf="errorHandling('isAlertAtDeviceLevel', 'required') && 
                                                                                    this.alertRuleFG.controls['isAlertAtDeviceLevel'].touched">
                                                    {{ FormErrorEnum.REQUIRED }}
                                                </mat-error>
                                            </div>
                                        </mat-radio-group>
                                    </div>
                                </div>

                                <div class="col-sm-6" *ngIf="alertRuleFG.get('isAlertAtDeviceLevel').value">
                                    <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                        <mat-label>Select device</mat-label>
                                        <mat-select formControlName="deviceID" multiple required>
                                            <ng-container *ngIf="devicesWithEntitiesM && devicesWithEntitiesM.length > 0 && devicesWithEntitiesM[0]['id']; else noDeviceFound">
                                                <mat-option [value]="-1" (click)="selectAllDevices()">
                                                    Select all devices
                                                </mat-option>
                                                <mat-optgroup *ngFor="let entity of devicesWithEntitiesM" [label]="entity.name" [disabled]="entity.disabled">
                                                    <mat-option *ngFor="let device of entity.devices" [value]="device.id" (click)="selectDevices(device.id)">
                                                        {{ device.name }}
                                                    </mat-option>
                                                </mat-optgroup>
                                            </ng-container>
                                            <ng-template #noDeviceFound>
                                                <mat-option disabled>
                                                    {{ COMMON_CONSTANT.NO_DATA_FOUND }}
                                                </mat-option>
                                            </ng-template>
                                        </mat-select>
                                        <mat-error *ngIf="errorHandling('deviceID', 'required')">
                                            {{ FormErrorEnum.REQUIRED }}
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                    </mat-card>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-sm-12">
                    <mat-card class="border cardOverwrite">
                        <div class="cardTitle">
                            Rule Definition
                        </div>

                        <div class="row">
                            <div class="col-sm-3">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select unit</mat-label>
                                    <mat-select (selectionChange)="unitChange($event.value)" formControlName="unitID" required>
                                        <ng-container *ngIf="unitM && unitM.length > 0 && unitM[0]['id']; else noUnitFound">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="unitSearchUtil.filterFC" placeholderLabel="Search by name"
                                                    noEntriesFoundLabel="No matching name found.">
                                                </ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let unit of unitSearchUtil.filteredEntities | async" [value]="unit.id">
                                                {{ unit.name }}
                                            </mat-option>
                                        </ng-container>
                                        <ng-template #noUnitFound>
                                            <mat-option disabled>
                                                {{ COMMON_CONSTANT.NO_DATA_FOUND }}
                                            </mat-option>
                                        </ng-template>
                                    </mat-select>
                                    <mat-error *ngIf="alertRuleFG.get('parameterID').invalid">
                                        Please select parameter first
                                    </mat-error>
                                    <mat-error *ngIf="errorHandling('unitID', 'required') && alertRuleFG.get('parameterID').valid">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-3" *ngIf="alertLabel == AlertTypeLabelEnum.PERIODIC_LABEL">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select alert type</mat-label>
                                    <mat-select formControlName="periodicAlertType" required>
                                        <ng-container
                                            *ngIf="periodicAlertType && periodicAlertType.length > 0 && periodicAlertType[0]['id']; else noPeriodicAlertTypeFound">
                                            <mat-option *ngFor="let type of periodicAlertType" [value]="type.keyID">
                                                {{ type.name }}
                                            </mat-option>
                                        </ng-container>
                                        <ng-template #noPeriodicAlertTypeFound>
                                            <mat-option disabled>
                                                {{ COMMON_CONSTANT.NO_DATA_FOUND }}
                                            </mat-option>
                                        </ng-template>
                                    </mat-select>
                                    <mat-error *ngIf="errorHandling('periodicAlertType', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-3">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select condition</mat-label>
                                    <mat-select formControlName="condition" (selectionChange)="conditionChange($event.value)" required>
                                        <mat-option *ngFor="let condition of conditionConstant" [value]="condition.value">
                                            {{ condition.label }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="errorHandling('condition', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div [ngClass]="{'col-sm-3': showValueField(), 'col-sm-2': !showValueField()}">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select frequency</mat-label>
                                    <mat-select formControlName="frequency" required>
                                        <mat-option *ngFor="let frequency of getFrequency()" [value]="frequency.value">
                                            {{ frequency.label }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="errorHandling('frequency', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div [ngClass]="{'col-sm-3': showValueField(), 'col-sm-2': !showValueField()}" *ngIf="showValueField()">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label class="formLabel"> Value {{ alertRuleFG.get('periodicAlertType').value == 'BUDGET' ? '%' : '' }}
                                    </mat-label>
                                    <input class="formPlaceholder" matInput type="number" [min]="0"
                                        [max]="alertRuleFG.get('periodicAlertType').value == 'BUDGET' ? 100 : null" placeholder="0.00"
                                        formControlName="value" required>
                                    <mat-error *ngIf="errorHandling('value', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                    <mat-error *ngIf="errorHandling('value', 'min')">
                                        {{ FormErrorEnum.NEGATIVE }}
                                    </mat-error>
                                    <mat-error *ngIf="errorHandling('value', 'max') && alertRuleFG.get('periodicAlertType').value == 'BUDGET'">
                                        % value cannot be more than 100
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-2" *ngIf="showStartEndFields()">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label class="formLabel"> Start value </mat-label>
                                    <input class="formPlaceholder" matInput type="number" placeholder="0.00" formControlName="startValue" required>
                                    <mat-error *ngIf="errorHandling('startValue', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                    <mat-error *ngIf="errorHandling('startValue', 'invalidRange')">
                                        Start value must be less than end value
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-2" *ngIf="showStartEndFields()">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label class="formLabel"> End value </mat-label>
                                    <input class="formPlaceholder" matInput type="number" placeholder="0.00" formControlName="endValue" required>
                                    <mat-error *ngIf="errorHandling('endValue', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                    <mat-error *ngIf="errorHandling('endValue', 'invalidRange')">
                                        End value must be greater than start value
                                    </mat-error>
                                </mat-form-field>
                            </div>

                        </div>
                    </mat-card>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-sm-12">
                    <mat-card class="border cardOverwrite">
                        <div class="cardTitle">
                            Alert Recipient: Select or Add
                        </div>
                        <div class="row userContext">
                            <div class="col-sm-12">
                                <span class="fw-bold text-secondary me-2"> Current org users </span>
                                <mat-slide-toggle class="slideToggleBtn mt-2" [formControl]="userFC"
                                    (change)="userContextChange()"></mat-slide-toggle>
                                <span class="fw-bold text-secondary ms-2"> All users </span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-6">
                                <mat-form-field class="matFieldWidth100"
                                    [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select user</mat-label>
                                    <mat-select [formControl]="selectedUserFC" required>
                                        <mat-select-trigger>
                                            Select users
                                        </mat-select-trigger>
                                        <ng-container *ngIf="userM && userM.length > 0 && userM[0]['id']; else noUserFound">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="userSearchUtil.filterFC" placeholderLabel="Search by name/email"
                                                    noEntriesFoundLabel="No matching name/email found.">
                                                </ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option class="matOptionNameEmail" *ngFor="let user of userSearchUtil.filteredEntities | async"
                                                [value]="user.id" (onSelectionChange)="onUserSelectionChange(user.id)">
                                                <!-- <span class="ms-3">
                                                    <img class="rounded-circle border profileImageDropdownView"
                                                        [src]="user.profileImgUrl || userService.defaultImage(
                                                        (user?.['firstName'] ? user['firstName'] + ' ' + user?.['lastName'] : ''), 
                                                        ProfileImg.PROFILE_IMAGE_DROPDOWN_NAME_VIEW)"alt="Profile image">
                                                </span> -->
                                                <span class="ms-3">
                                                    {{ user.firstName }} {{ user?.lastName }}
                                                </span>
                                                <br />
                                                <span class="ms-3 text-secondary"> {{user.email}} </span>
                                            </mat-option>
                                        </ng-container>
                                        <ng-template #noUserFound>
                                            <mat-option disabled>
                                                {{ COMMON_CONSTANT.NO_DATA_FOUND }}
                                            </mat-option>
                                        </ng-template>
                                    </mat-select>
                                    <mat-error *ngIf="selectedUserFC.hasError('required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-6" *ngIf="selectedUserIds?.length > 0">
                                <mat-card class="border card">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <span class="cardTitle">
                                                Selected users
                                            </span>
                                        </div>
                                    </div>
                                    <perfect-scrollbar class="scrollHeight">
                                        <div class="row mt-2">
                                            <div class="col-sm-12" *ngFor="let user of getSelectedUsers()">
                                                <div class="d-flex align-items-center">
                                                    <div class="profileImgContainer">
                                                        <img class="profileImg rounded-circle border" [src]="user.profileImgUrl || userService.defaultImage(
                                                            (user?.['firstName'] ? user['firstName'] + ' ' + user?.['lastName'] : ''), 
                                                            ProfileImg.PROFILE_IMAGE_DROPDOWN_NAME_VIEW)"
                                                            alt="Profile img" />
                                                    </div>
                                                    <div class="ps-1 lineHeight">
                                                        <span> {{ user.firstName }} {{ user?.lastName }} </span>
                                                        <br />
                                                        <span class="text-secondary"> {{user.email}} </span>
                                                    </div>
                                                    <div class="ms-auto">
                                                        <span
                                                            class="material-symbols-outlined me-3 text-danger cursorPointer"
                                                            matTooltip="Remove selected user" matTooltipPosition="above"
                                                            (click)="removeSelectedUsers(user.id)">
                                                            cancel
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </perfect-scrollbar>
                                </mat-card>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-6">
                                <mat-checkbox formControlName="isAnyOtherUser" (change)="addOtherUser($event)">
                                    Any other user
                                </mat-checkbox>
                            </div>
                            <div class="col-sm-6" *ngIf="alertRuleFG.controls['isAnyOtherUser'].value == true">
                                <mat-form-field class="matFieldWidth100"
                                    [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Enter user email</mat-label>
                                    <mat-chip-list #chipList required>
                                        <mat-chip *ngFor="let email of otherUserEmail.value" [removable]="removable"
                                            (removed)="removeEmail(email)">
                                            {{ email }}
                                            <button matChipRemove *ngIf="removable">
                                                <mat-icon>cancel</mat-icon>
                                            </button>
                                        </mat-chip>
                                        <input [placeholder]="inputPlaceholder" [matChipInputFor]="chipList"
                                            [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                            [matChipInputAddOnBlur]="addOnBlur" (matChipInputTokenEnd)="add($event)"
                                            (input)="onInput()">
                                        <mat-error class="userEmailError" *ngIf="otherUserEmail.hasError('required')">
                                            {{ FormErrorEnum.REQUIRED }}
                                        </mat-error>
                                    </mat-chip-list>
                                </mat-form-field>
                            </div>
                        </div>
                    </mat-card>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-sm-12">
                    <mat-card class="border cardOverwrite">
                        <div class="cardTitle">
                            Notification Preferences
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select SMS frequency</mat-label>
                                    <mat-select formControlName="smsFrequency" required>
                                        <mat-option *ngFor="let smsFreq of LIST_CONSTANT.SMS_FREQUENCY" [value]="smsFreq.value">
                                            {{ smsFreq.label }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="errorHandling('smsFrequency', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="col-sm-6">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select email frequency</mat-label>
                                    <mat-select formControlName="emailFrequency" required>
                                        <mat-option *ngFor="let emailFreq of LIST_CONSTANT.EMAIL_FREQUENCY" [value]="emailFreq.value">
                                            {{ emailFreq.label }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="errorHandling('emailFrequency', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="ps-1 radioBtnField">
                                    <div class="radioBtnGroupLabel"> Is this alert shift specific?
                                    </div>
                                    <mat-radio-group formControlName="isShift">
                                        <div class="row my-2">
                                            <div class="col-sm-6">
                                                <mat-radio-button class="radioBtnLabel" [value]="true">
                                                    Yes
                                                </mat-radio-button>
                                            </div>
                                            <div class="col-sm-6">
                                                <mat-radio-button class="radioBtnLabel" [value]="false">
                                                    No
                                                </mat-radio-button>
                                            </div>
                                            <mat-error class="textMatError ms-1 mt-1" *ngIf="errorHandling('isShift', 'required')">
                                                {{ FormErrorEnum.REQUIRED }}
                                            </mat-error>
                                        </div>
                                    </mat-radio-group>
                                </div>
                            </div>
                            <div class="col-sm-6" *ngIf="alertRuleFG.get('isShift').value">
                                <mat-form-field class="matFieldWidth100" [appearance]="MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE">
                                    <mat-label>Select shift</mat-label>

                                    <mat-select formControlName="shiftID" multiple required>
                                        <ng-container *ngIf="shiftM && shiftM.length > 0 && shiftM[0]['id']; else noDataOption">
                                            <mat-option [value]="-1" (click)="selectAllShifts()">
                                                Select all
                                            </mat-option>
                                            <mat-option *ngFor="let shift of shiftM" [value]="shift.id" (click)="selectedShift()">
                                                {{ shift.name }}
                                            </mat-option>
                                        </ng-container>

                                        <ng-template #noDataOption>
                                            <mat-option disabled>
                                                {{ COMMON_CONSTANT.NO_DATA_FOUND }}
                                            </mat-option>
                                        </ng-template>
                                    </mat-select>

                                    <mat-error *ngIf="errorHandling('shiftID', 'required')">
                                        {{ FormErrorEnum.REQUIRED }}
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </mat-card>
                </div>
            </div>

            <div align="end" class="mt-3">
                <button type="button" class="btn btn-sm btn-secondary me-2" (click)="tscCommonService.back()">
                    {{ ButtonLabelEnum.CANCEL_BTN_LABEL }}
                </button>
                <button type="submit" class="btn btn-sm btn-success" (click)="createUpdateAlert()"
                    [ngClass]="{'disabled': action == FormAction.UPDATE && isEqual}">
                    {{ action == FormAction.CREATE ? ButtonLabelEnum.CREATE_BTN_LABEL :
                    ButtonLabelEnum.UPDATE_BTN_LABEL }}
                </button>
            </div>
        </form>
    </div>
</div>