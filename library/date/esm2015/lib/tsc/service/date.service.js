import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import * as moment from 'moment-timezone';
import { DateTimeIntervalEnum } from '../enum/date.enum';
import { MONTH_CONSTANT } from '../constant/month.constant';
import { Organization } from '@library/organization-service';
import { COMMON_CONSTANT } from '@library/tsc-common';
import * as i0 from "@angular/core";
import * as i1 from "@library/storage-service";
import * as i2 from "@library/organization-service";
// /tsc-library/
export class DateService {
    constructor(storageService, organizationSerive) {
        this.storageService = storageService;
        this.organizationSerive = organizationSerive;
        this.organizationM = new Organization();
    }
    takeFocusAway(duration) {
        const fieldElement = document.getElementById(duration);
        if (fieldElement) {
            fieldElement.classList.remove('mat-focused');
            if (fieldElement.classList.contains('mat-form-field-invalid')) {
                fieldElement.classList.remove('mat-form-field-should-float');
            }
            else {
                fieldElement.classList.add('mat-form-field-should-float');
            }
        }
    }
    openDatepickerOnClick(datepicker) {
        if (!datepicker.opened) {
            datepicker.open();
        }
    }
    handleDateInput(normalizedDate, datepicker, format) {
        datepicker.close();
        return moment(normalizedDate).format(format);
    }
    yearSelectedHandler(normalizedYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedYear).format("YYYY");
        return duration;
    }
    monthSelectedHandler(normalizedMonthAndYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedMonthAndYear).format("YYYY-MM");
        return duration;
    }
    dailySelectedHandler(selectedDate) {
        let duration = moment(selectedDate).format("YYYY-MM-DD");
        return duration;
    }
    formatDate(selectedDate, format) {
        const date = new Date(selectedDate);
        return moment(date).format(format);
    }
    convertUtcToTimeZone(utcTimeString, targetTimeZone, format) {
        const utcDate = moment(utcTimeString);
        let convertedTimeZone = utcDate.tz(targetTimeZone).format(format);
        return convertedTimeZone;
    }
    getRelativeTimeAgoLabel(dateTime, timezone) {
        return dateTime ? moment.tz(dateTime, timezone).fromNow() : COMMON_CONSTANT.HYPHEN;
    }
    getStartDateTime(selectedRange) {
        let startTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_HOUR:
                startTime = moment().startOf('hour').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_24_HRS:
                startTime = moment().subtract(24, 'hours').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.YESTERDAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_WEEK:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_7_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(7, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_MONTH:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_30_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(30, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12_MONTHS:
                startTime = moment().subtract(1, 'year').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12th_MONTH:
                startTime = moment().subtract(1, 'year').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                startTime = moment().set({ month: 0, date: 1, hour: 0, minute: 0, second: 0, millisecond: 0 }).tz(timezone).format();
                break;
            default:
                startTime = null;
        }
        return startTime;
    }
    getEndDateTime(selectedRange) {
        let endTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_TIME:
                endTime = moment().tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'days').startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_WEEK:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'week').startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_MONTH:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'months').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                endTime = moment().startOf('year').tz(timezone).format();
                break;
            default:
                endTime = null;
        }
        return endTime;
    }
    getReportingPeriodList(orgID, endYearLength) {
        return __awaiter(this, void 0, void 0, function* () {
            this.organizationM = (yield this.organizationSerive.getOrganizationByID(orgID));
            let reportingPeriodsList = [];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const startMonth = this.getMonthIndex(this.organizationM.fiscalStartMonth);
            let endMonth = (startMonth + 11) % 12;
            for (let year = currentYear; year >= currentYear - endYearLength; year--) {
                let startYear = year;
                let endYear;
                if (startMonth == 0) {
                    endYear = startYear;
                }
                else {
                    endYear = startYear + 1;
                }
                let startDate = new Date(startYear, startMonth);
                let endDate = new Date(endYear, endMonth + 1, 0);
                let startMonthLabel = startDate.toLocaleString('default', { month: 'short' });
                let endMonthLabel = endDate.toLocaleString('default', { month: 'short' });
                let period = {
                    name: `${startMonthLabel} ${startYear} - ${endMonthLabel} ${endYear}`,
                    startDate: moment(startDate).format("YYYY-MM-DD"),
                    endDate: moment(endDate).format("YYYY-MM-DD")
                };
                reportingPeriodsList.push(period);
            }
            return reportingPeriodsList;
        });
    }
    getMonthIndex(month) {
        return MONTH_CONSTANT.indexOf(month);
    }
    getCurrentYear() {
        const currentYear = new Date().getFullYear();
        return currentYear;
    }
}
DateService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, deps: [{ token: i1.StorageService }, { token: i2.OrganizationService }], target: i0.ɵɵFactoryTarget.Injectable });
DateService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.StorageService }, { type: i2.OrganizationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGlicmFyeS9kYXRlL3NyYy9saWIvdHNjL3NlcnZpY2UvZGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE9BQU8sS0FBSyxNQUFNLE1BQU0saUJBQWlCLENBQUM7QUFFMUMsT0FBTyxFQUFrQixvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUk1RCxPQUFPLEVBQUUsWUFBWSxFQUFzQyxNQUFNLCtCQUErQixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7OztBQUN0RCxnQkFBZ0I7QUFNaEIsTUFBTSxPQUFPLFdBQVc7SUFJcEIsWUFDWSxjQUE4QixFQUM5QixrQkFBdUM7UUFEdkMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBcUI7UUFKbkQsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0lBSy9CLENBQUM7SUFFTCxhQUFhLENBQUMsUUFBZ0I7UUFDMUIsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV2RCxJQUFJLFlBQVksRUFBRTtZQUNkLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRTdDLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsd0JBQXdCLENBQUMsRUFBRTtnQkFDM0QsWUFBWSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsNkJBQTZCLENBQUMsQ0FBQzthQUNoRTtpQkFBTTtnQkFDSCxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcs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U0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBRTFFLElBQUksTUFBTSxHQUFHO29CQUNULElBQUksRUFBRSxHQUFHLGVBQWUsSUFBSSxTQUFTLE1BQU0sYUFBYSxJQUFJLE9BQU8sRUFBRTtvQkFDckUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO29CQUNqRCxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7aUJBQ2hELENBQUM7Z0JBQ0Ysb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsT0FBTyxvQkFBb0IsQ0FBQztRQUNoQyxDQUFDO0tBQUE7SUFFRCxhQUFhLENBQUMsS0FBYTtRQUN2QixPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELGNBQWM7UUFDVixNQUFNLFdBQVcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7O3lHQXRMUSxXQUFXOzZHQUFYLFdBQVcsY0FIUixNQUFNOzRGQUdULFdBQVc7a0JBSnZCLFVBQVU7bUJBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXREYXRlcGlja2VyIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGF0ZXBpY2tlcic7XG5cbmltcG9ydCB7IE1vbWVudCB9IGZyb20gJ21vbWVudCc7XG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50LXRpbWV6b25lJztcblxuaW1wb3J0IHsgRGF0ZUZvcm1hdEVudW0sIERhdGVUaW1lSW50ZXJ2YWxFbnVtIH0gZnJvbSAnLi4vZW51bS9kYXRlLmVudW0nO1xuaW1wb3J0IHsgTU9OVEhfQ09OU1RBTlQgfSBmcm9tICcuLi9jb25zdGFudC9tb250aC5jb25zdGFudCc7XG5cbi8vIHRzYy1saWJyYXJ5XG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJ0BsaWJyYXJ5L3N0b3JhZ2Utc2VydmljZSc7XG5pbXBvcnQgeyBPcmdhbml6YXRpb24sIE9yZ2FuaXphdGlvbk0sIE9yZ2FuaXphdGlvblNlcnZpY2UgfSBmcm9tICdAbGlicmFyeS9vcmdhbml6YXRpb24tc2VydmljZSc7XG5pbXBvcnQgeyBDT01NT05fQ09OU1RBTlQgfSBmcm9tICdAbGlicmFyeS90c2MtY29tbW9uJztcbi8vIC90c2MtbGlicmFyeS9cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcblxuZXhwb3J0IGNsYXNzIERhdGVTZXJ2aWNlIHtcblxuICAgIG9yZ2FuaXphdGlvbk0gPSBuZXcgT3JnYW5pemF0aW9uKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBzdG9yYWdlU2VydmljZTogU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgb3JnYW5pemF0aW9uU2VyaXZlOiBPcmdhbml6YXRpb25TZXJ2aWNlXG4gICAgKSB7IH1cblxuICAgIHRha2VGb2N1c0F3YXkoZHVyYXRpb246IHN0cmluZykge1xuICAgICAgICBjb25zdCBmaWVsZEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChkdXJhdGlvbik7XG5cbiAgICAgICAgaWYgKGZpZWxkRWxlbWVudCkge1xuICAgICAgICAgICAgZmllbGRFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ21hdC1mb2N1c2VkJyk7XG5cbiAgICAgICAgICAgIGlmIChmaWVsZEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdtYXQtZm9ybS1maWVsZC1pbnZhbGlkJykpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnbWF0LWZvcm0tZmllbGQtc2hvdWxkLWZsb2F0Jyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZpZWxkRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdtYXQtZm9ybS1maWVsZC1zaG91bGQtZmxvYXQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9wZW5EYXRlcGlja2VyT25DbGljayhkYXRlcGlja2VyOiBNYXREYXRlcGlja2VyPE1vbWVudD4pIHtcbiAgICAgICAgaWYgKCFkYXRlcGlja2VyLm9wZW5lZCkge1xuICAgICAgICAgICAgZGF0ZXBpY2tlci5vcGVuKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBoYW5kbGVEYXRlSW5wdXQobm9ybWFsaXplZERhdGU6IE1vbWVudCwgZGF0ZXBpY2tlcjogTWF0RGF0ZXBpY2tlcjxNb21lbnQ+LCBmb3JtYXQ6IHN0cmluZykge1xuICAgICAgICBkYXRlcGlja2VyLmNsb3NlKCk7XG4gICAgICAgIHJldHVybiBtb21lbnQobm9ybWFsaXplZERhdGUpLmZvcm1hdChmb3JtYXQpO1xuICAgIH1cblxuICAgIHllYXJTZWxlY3RlZEhhbmRsZXIobm9ybWFsaXplZFllYXI6IE1vbWVudCwgZGF0ZXBpY2tlcjogTWF0RGF0ZXBpY2tlcjxNb21lbnQ+KSB7XG4gICAgICAgIGRhdGVwaWNrZXIuY2xvc2UoKTtcbiAgICAgICAgbGV0IGR1cmF0aW9uID0gbW9tZW50KG5vcm1hbGl6ZWRZZWFyKS5mb3JtYXQoXCJZWVlZXCIpO1xuICAgICAgICByZXR1cm4gZHVyYXRpb247XG4gICAgfVxuXG4gICAgbW9udGhTZWxlY3RlZEhhbmRsZXIobm9ybWFsaXplZE1vbnRoQW5kWWVhcjogTW9tZW50LCBkYXRlcGlja2VyOiBNYXREYXRlcGlja2VyPE1vbWVudD4pIHtcbiAgICAgICAgZGF0ZXBpY2tlci5jbG9zZSgpO1xuICAgICAgICBsZXQgZHVyYXRpb24gPSBtb21lbnQobm9ybWFsaXplZE1vbnRoQW5kWWVhcikuZm9ybWF0KFwiWVlZWS1NTVwiKTtcbiAgICAgICAgcmV0dXJuIGR1cmF0aW9uO1xuICAgIH1cblxuICAgIGRhaWx5U2VsZWN0ZWRIYW5kbGVyKHNlbGVjdGVkRGF0ZTogTW9tZW50KSB7XG4gICAgICAgIGxldCBkdXJhdGlvbiA9IG1vbWVudChzZWxlY3RlZERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIik7XG4gICAgICAgIHJldHVybiBkdXJhdGlvbjtcbiAgICB9XG5cbiAgICBmb3JtYXREYXRlKHNlbGVjdGVkRGF0ZTogc3RyaW5nLCBmb3JtYXQ6IERhdGVGb3JtYXRFbnVtKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShzZWxlY3RlZERhdGUpO1xuICAgICAgICByZXR1cm4gbW9tZW50KGRhdGUpLmZvcm1hdChmb3JtYXQpO1xuICAgIH1cblxuICAgIGNvbnZlcnRVdGNUb1RpbWVab25lKHV0Y1RpbWVTdHJpbmc6IHN0cmluZywgdGFyZ2V0VGltZVpvbmU6IHN0cmluZywgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdXRjRGF0ZSA9IG1vbWVudCh1dGNUaW1lU3RyaW5nKTtcbiAgICAgICAgbGV0IGNvbnZlcnRlZFRpbWVab25lID0gdXRjRGF0ZS50eih0YXJnZXRUaW1lWm9uZSkuZm9ybWF0KGZvcm1hdCk7XG4gICAgICAgIHJldHVybiBjb252ZXJ0ZWRUaW1lWm9uZTtcbiAgICB9XG5cbiAgICBnZXRSZWxhdGl2ZVRpbWVBZ29MYWJlbChkYXRlVGltZTogc3RyaW5nLCB0aW1lem9uZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGRhdGVUaW1lID8gbW9tZW50LnR6KGRhdGVUaW1lLCB0aW1lem9uZSkuZnJvbU5vdygpIDogQ09NTU9OX0NPTlNUQU5ULkhZUEhFTjtcbiAgICB9XG5cbiAgICBnZXRTdGFydERhdGVUaW1lKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgbGV0IHN0YXJ0VGltZTogc3RyaW5nO1xuXG4gICAgICAgIGNvbnN0IHRpbWV6b25lID0gdGhpcy5zdG9yYWdlU2VydmljZS5nZXRTdG9yYWdlKCd0aW1lem9uZScpO1xuXG4gICAgICAgIHN3aXRjaCAoc2VsZWN0ZWRSYW5nZSkge1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX0hPVVI6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3RhcnRPZignaG91cicpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTEFTVF8yNF9IUlM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3VidHJhY3QoMjQsICdob3VycycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uWUVTVEVSREFZOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdWJ0cmFjdCgxLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9EQVk6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN0YXJ0T2YoJ2RheScpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9XRUVLOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdGFydE9mKCd3ZWVrJykuYWRkKDEsICdkYXlzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzdfREFZUzpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3VidHJhY3QoNywgJ2RheXMnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfTU9OVEg6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN0YXJ0T2YoJ21vbnRoJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzMwX0RBWVM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN1YnRyYWN0KDMwLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTEFTVF8xMl9NT05USFM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3VidHJhY3QoMSwgJ3llYXInKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkxBU1RfMTJ0aF9NT05USDpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcicpLnN0YXJ0T2YoJ21vbnRoJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX1lFQVI6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgbW9udGg6IDAsIGRhdGU6IDEsIGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3RhcnRUaW1lO1xuICAgIH1cblxuICAgIGdldEVuZERhdGVUaW1lKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgbGV0IGVuZFRpbWU6IHN0cmluZztcblxuICAgICAgICBjb25zdCB0aW1lem9uZSA9IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0U3RvcmFnZSgndGltZXpvbmUnKTtcblxuICAgICAgICBzd2l0Y2ggKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9USU1FOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfREFZOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3RhcnRPZignZGF5JykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5ORVhUX0RBWTpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLmFkZCgxLCAnZGF5cycpLnN0YXJ0T2YoJ2RheScpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTkVYVF9XRUVLOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuYWRkKDEsICd3ZWVrJykuc3RhcnRPZignd2VlaycpLmFkZCgxLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTkVYVF9NT05USDpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLmFkZCgxLCAnbW9udGhzJykuc3RhcnRPZignbW9udGgnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfWUVBUjpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc3RhcnRPZigneWVhcicpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgZW5kVGltZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVuZFRpbWU7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0UmVwb3J0aW5nUGVyaW9kTGlzdChvcmdJRCwgZW5kWWVhckxlbmd0aCkge1xuICAgICAgICB0aGlzLm9yZ2FuaXphdGlvbk0gPSA8T3JnYW5pemF0aW9uTT5hd2FpdCB0aGlzLm9yZ2FuaXphdGlvblNlcml2ZS5nZXRPcmdhbml6YXRpb25CeUlEKG9yZ0lEKTtcbiAgICAgICAgbGV0IHJlcG9ydGluZ1BlcmlvZHNMaXN0ID0gW107XG4gICAgICAgIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29uc3QgY3VycmVudFllYXIgPSBjdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICBjb25zdCBzdGFydE1vbnRoID0gdGhpcy5nZXRNb250aEluZGV4KHRoaXMub3JnYW5pemF0aW9uTS5maXNjYWxTdGFydE1vbnRoKTtcbiAgICAgICAgbGV0IGVuZE1vbnRoID0gKHN0YXJ0TW9udGggKyAxMSkgJSAxMjtcblxuICAgICAgICBmb3IgKGxldCB5ZWFyID0gY3VycmVudFllYXI7IHllYXIgPj0gY3VycmVudFllYXIgLSBlbmRZZWFyTGVuZ3RoOyB5ZWFyLS0pIHtcbiAgICAgICAgICAgIGxldCBzdGFydFllYXIgPSB5ZWFyO1xuICAgICAgICAgICAgbGV0IGVuZFllYXI7XG4gICAgICAgICAgICBpZiAoc3RhcnRNb250aCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgZW5kWWVhciA9IHN0YXJ0WWVhcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZW5kWWVhciA9IHN0YXJ0WWVhciArIDE7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBzdGFydERhdGUgPSBuZXcgRGF0ZShzdGFydFllYXIsIHN0YXJ0TW9udGgpO1xuICAgICAgICAgICAgbGV0IGVuZERhdGUgPSBuZXcgRGF0ZShlbmRZZWFyLCBlbmRNb250aCArIDEsIDApOyBcblxuICAgICAgICAgICAgbGV0IHN0YXJ0TW9udGhMYWJlbCA9IHN0YXJ0RGF0ZS50b0xvY2FsZVN0cmluZygnZGVmYXVsdCcsIHsgbW9udGg6ICdzaG9ydCcgfSk7XG4gICAgICAgICAgICBsZXQgZW5kTW9udGhMYWJlbCA9IGVuZERhdGUudG9Mb2NhbGVTdHJpbmcoJ2RlZmF1bHQnLCB7IG1vbnRoOiAnc2hvcnQnIH0pO1xuXG4gICAgICAgICAgICBsZXQgcGVyaW9kID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6IGAke3N0YXJ0TW9udGhMYWJlbH0gJHtzdGFydFllYXJ9IC0gJHtlbmRNb250aExhYmVsfSAke2VuZFllYXJ9YCxcbiAgICAgICAgICAgICAgICBzdGFydERhdGU6IG1vbWVudChzdGFydERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIiksXG4gICAgICAgICAgICAgICAgZW5kRGF0ZTogbW9tZW50KGVuZERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIilcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXBvcnRpbmdQZXJpb2RzTGlzdC5wdXNoKHBlcmlvZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcG9ydGluZ1BlcmlvZHNMaXN0O1xuICAgIH1cblxuICAgIGdldE1vbnRoSW5kZXgobW9udGg6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiBNT05USF9DT05TVEFOVC5pbmRleE9mKG1vbnRoKTtcbiAgICB9XG5cbiAgICBnZXRDdXJyZW50WWVhcigpIHtcbiAgICAgICAgY29uc3QgY3VycmVudFllYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7XG4gICAgICAgIHJldHVybiBjdXJyZW50WWVhcjtcbiAgICB9XG59Il19