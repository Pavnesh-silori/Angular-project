import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import * as moment from 'moment-timezone';
import { DateTimeIntervalEnum } from '../enum/date.enum';
import { MONTH_CONSTANT } from '../constant/month.constant';
import { Organization } from '@library/organization-service';
import { COMMON_CONSTANT } from '@library/tsc-common';
import * as i0 from "@angular/core";
import * as i1 from "@library/storage-service";
import * as i2 from "@library/organization-service";
// /tsc-library/
export class DateService {
    constructor(storageService, organizationSerive) {
        this.storageService = storageService;
        this.organizationSerive = organizationSerive;
        this.organizationM = new Organization();
    }
    takeFocusAway(duration) {
        return document.getElementById(duration).classList.remove('mat-focused', 'mat-form-field-should-float');
    }
    openDatepickerOnClick(datepicker) {
        if (!datepicker.opened) {
            datepicker.open();
        }
    }
    handleDateInput(normalizedDate, datepicker, format) {
        datepicker.close();
        return moment(normalizedDate).format(format);
    }
    yearSelectedHandler(normalizedYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedYear).format("YYYY");
        return duration;
    }
    monthSelectedHandler(normalizedMonthAndYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedMonthAndYear).format("YYYY-MM");
        return duration;
    }
    dailySelectedHandler(selectedDate) {
        let duration = moment(selectedDate).format("YYYY-MM-DD");
        return duration;
    }
    formatDate(selectedDate, format) {
        const date = new Date(selectedDate);
        return moment(date).format(format);
    }
    convertUtcToTimeZone(utcTimeString, targetTimeZone, format) {
        const utcDate = moment(utcTimeString);
        let convertedTimeZone = utcDate.tz(targetTimeZone).format(format);
        return convertedTimeZone;
    }
    getRelativeTimeAgoLabel(dateTime, timezone) {
        return dateTime ? moment.tz(dateTime, timezone).fromNow() : COMMON_CONSTANT.HYPHEN;
    }
    getStartDateTime(selectedRange) {
        let startTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_HOUR:
                startTime = moment().startOf('hour').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_24_HRS:
                startTime = moment().subtract(24, 'hours').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.YESTERDAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_WEEK:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_7_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(7, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_MONTH:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_30_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(30, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12_MONTHS:
                startTime = moment().subtract(1, 'year').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12th_MONTH:
                startTime = moment().subtract(1, 'year').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                startTime = moment().set({ month: 0, date: 1, hour: 0, minute: 0, second: 0, millisecond: 0 }).tz(timezone).format();
                break;
            default:
                startTime = null;
        }
        return startTime;
    }
    getEndDateTime(selectedRange) {
        let endTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_TIME:
                endTime = moment().tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'days').startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_WEEK:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'week').startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_MONTH:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'months').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                endTime = moment().startOf('year').tz(timezone).format();
                break;
            default:
                endTime = null;
        }
        return endTime;
    }
    getReportingPeriodList(orgID, endYearLength) {
        return __awaiter(this, void 0, void 0, function* () {
            this.organizationM = (yield this.organizationSerive.getOrganizationByID(orgID));
            let reportingPeriodsList = [];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const startMonth = this.getMonthIndex(this.organizationM.fiscalStartMonth);
            let endMonth = (startMonth + 11) % 12;
            for (let year = currentYear; year >= currentYear - endYearLength; year--) {
                let startYear = year;
                let endYear;
                if (startMonth == 0) {
                    endYear = startYear;
                }
                else {
                    endYear = startYear + 1;
                }
                let startDate = new Date(startYear, startMonth);
                let endDate = new Date(endYear, endMonth);
                let startMonthLabel = startDate.toLocaleString('default', { month: 'short' });
                let endMonthLabel = endDate.toLocaleString('default', { month: 'short' });
                let period = {
                    name: `${startMonthLabel} ${startYear} - ${endMonthLabel} ${endYear}`,
                    startDate: moment(startDate).format("YYYY-MM-DD"),
                    endDate: moment(endDate).format("YYYY-MM-DD")
                };
                reportingPeriodsList.push(period);
            }
            return reportingPeriodsList;
        });
    }
    getMonthIndex(month) {
        return MONTH_CONSTANT.indexOf(month);
    }
}
DateService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, deps: [{ token: i1.StorageService }, { token: i2.OrganizationService }], target: i0.ɵɵFactoryTarget.Injectable });
DateService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.StorageService }, { type: i2.OrganizationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGlicmFyeS9kYXRlL3NyYy9saWIvdHNjL3NlcnZpY2UvZGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE9BQU8sS0FBSyxNQUFNLE1BQU0saUJBQWlCLENBQUM7QUFFMUMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBSTVELE9BQU8sRUFBRSxZQUFZLEVBQXNDLE1BQU0sK0JBQStCLENBQUM7QUFDakcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBQ3RELGdCQUFnQjtBQU1oQixNQUFNLE9BQU8sV0FBVztJQUlwQixZQUNZLGNBQThCLEVBQzlCLGtCQUF1QztRQUR2QyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFxQjtRQUpuRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7SUFLL0IsQ0FBQztJQUVMLGFBQWEsQ0FBQyxRQUFRO1FBQ2xCLE9BQU8sUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSw2QkFBNkIsQ0FBQyxDQUFDO0lBQzVHLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxVQUFpQztRQUNuRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUNwQixVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDckI7SUFDTCxDQUFDO0lBRUQsZUFBZSxDQUFDLGNBQXNCLEVBQUUsVUFBaUMsRUFBRSxNQUFjO1FBQ3JGLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztR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QVksQ0FBQztpQkFDaEQsQ0FBQztnQkFDRixvQkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDckM7WUFDRCxPQUFPLG9CQUFvQixDQUFDO1FBQ2hDLENBQUM7S0FBQTtJQUVELGFBQWEsQ0FBQyxLQUFhO1FBQ3ZCLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6QyxDQUFDOzt5R0F2S1EsV0FBVzs2R0FBWCxXQUFXLGNBSFIsTUFBTTs0RkFHVCxXQUFXO2tCQUp2QixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQiIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWF0RGF0ZXBpY2tlciB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RhdGVwaWNrZXInO1xuXG5pbXBvcnQgeyBNb21lbnQgfSBmcm9tICdtb21lbnQnO1xuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudC10aW1lem9uZSc7XG5cbmltcG9ydCB7IERhdGVUaW1lSW50ZXJ2YWxFbnVtIH0gZnJvbSAnLi4vZW51bS9kYXRlLmVudW0nO1xuaW1wb3J0IHsgTU9OVEhfQ09OU1RBTlQgfSBmcm9tICcuLi9jb25zdGFudC9tb250aC5jb25zdGFudCc7XG5cbi8vIHRzYy1saWJyYXJ5XG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJ0BsaWJyYXJ5L3N0b3JhZ2Utc2VydmljZSc7XG5pbXBvcnQgeyBPcmdhbml6YXRpb24sIE9yZ2FuaXphdGlvbk0sIE9yZ2FuaXphdGlvblNlcnZpY2UgfSBmcm9tICdAbGlicmFyeS9vcmdhbml6YXRpb24tc2VydmljZSc7XG5pbXBvcnQgeyBDT01NT05fQ09OU1RBTlQgfSBmcm9tICdAbGlicmFyeS90c2MtY29tbW9uJztcbi8vIC90c2MtbGlicmFyeS9cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcblxuZXhwb3J0IGNsYXNzIERhdGVTZXJ2aWNlIHtcblxuICAgIG9yZ2FuaXphdGlvbk0gPSBuZXcgT3JnYW5pemF0aW9uKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBzdG9yYWdlU2VydmljZTogU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgb3JnYW5pemF0aW9uU2VyaXZlOiBPcmdhbml6YXRpb25TZXJ2aWNlXG4gICAgKSB7IH1cblxuICAgIHRha2VGb2N1c0F3YXkoZHVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGR1cmF0aW9uKS5jbGFzc0xpc3QucmVtb3ZlKCdtYXQtZm9jdXNlZCcsICdtYXQtZm9ybS1maWVsZC1zaG91bGQtZmxvYXQnKTtcbiAgICB9XG5cbiAgICBvcGVuRGF0ZXBpY2tlck9uQ2xpY2soZGF0ZXBpY2tlcjogTWF0RGF0ZXBpY2tlcjxNb21lbnQ+KSB7XG4gICAgICAgIGlmICghZGF0ZXBpY2tlci5vcGVuZWQpIHtcbiAgICAgICAgICAgIGRhdGVwaWNrZXIub3BlbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaGFuZGxlRGF0ZUlucHV0KG5vcm1hbGl6ZWREYXRlOiBNb21lbnQsIGRhdGVwaWNrZXI6IE1hdERhdGVwaWNrZXI8TW9tZW50PiwgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgZGF0ZXBpY2tlci5jbG9zZSgpO1xuICAgICAgICByZXR1cm4gbW9tZW50KG5vcm1hbGl6ZWREYXRlKS5mb3JtYXQoZm9ybWF0KTtcbiAgICB9XG5cbiAgICB5ZWFyU2VsZWN0ZWRIYW5kbGVyKG5vcm1hbGl6ZWRZZWFyOiBNb21lbnQsIGRhdGVwaWNrZXI6IE1hdERhdGVwaWNrZXI8TW9tZW50Pikge1xuICAgICAgICBkYXRlcGlja2VyLmNsb3NlKCk7XG4gICAgICAgIGxldCBkdXJhdGlvbiA9IG1vbWVudChub3JtYWxpemVkWWVhcikuZm9ybWF0KFwiWVlZWVwiKTtcbiAgICAgICAgcmV0dXJuIGR1cmF0aW9uO1xuICAgIH1cblxuICAgIG1vbnRoU2VsZWN0ZWRIYW5kbGVyKG5vcm1hbGl6ZWRNb250aEFuZFllYXI6IE1vbWVudCwgZGF0ZXBpY2tlcjogTWF0RGF0ZXBpY2tlcjxNb21lbnQ+KSB7XG4gICAgICAgIGRhdGVwaWNrZXIuY2xvc2UoKTtcbiAgICAgICAgbGV0IGR1cmF0aW9uID0gbW9tZW50KG5vcm1hbGl6ZWRNb250aEFuZFllYXIpLmZvcm1hdChcIllZWVktTU1cIik7XG4gICAgICAgIHJldHVybiBkdXJhdGlvbjtcbiAgICB9XG5cbiAgICBkYWlseVNlbGVjdGVkSGFuZGxlcihzZWxlY3RlZERhdGU6IE1vbWVudCkge1xuICAgICAgICBsZXQgZHVyYXRpb24gPSBtb21lbnQoc2VsZWN0ZWREYXRlKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpO1xuICAgICAgICByZXR1cm4gZHVyYXRpb247XG4gICAgfVxuXG4gICAgZm9ybWF0RGF0ZShzZWxlY3RlZERhdGU6IHN0cmluZywgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHNlbGVjdGVkRGF0ZSk7XG4gICAgICAgIHJldHVybiBtb21lbnQoZGF0ZSkuZm9ybWF0KGZvcm1hdCk7XG4gICAgfVxuXG4gICAgY29udmVydFV0Y1RvVGltZVpvbmUodXRjVGltZVN0cmluZzogc3RyaW5nLCB0YXJnZXRUaW1lWm9uZTogc3RyaW5nLCBmb3JtYXQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCB1dGNEYXRlID0gbW9tZW50KHV0Y1RpbWVTdHJpbmcpO1xuICAgICAgICBsZXQgY29udmVydGVkVGltZVpvbmUgPSB1dGNEYXRlLnR6KHRhcmdldFRpbWVab25lKS5mb3JtYXQoZm9ybWF0KTtcbiAgICAgICAgcmV0dXJuIGNvbnZlcnRlZFRpbWVab25lO1xuICAgIH1cblxuICAgIGdldFJlbGF0aXZlVGltZUFnb0xhYmVsKGRhdGVUaW1lOiBzdHJpbmcsIHRpbWV6b25lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZGF0ZVRpbWUgPyBtb21lbnQudHooZGF0ZVRpbWUsIHRpbWV6b25lKS5mcm9tTm93KCkgOiBDT01NT05fQ09OU1RBTlQuSFlQSEVOO1xuICAgIH1cblxuICAgIGdldFN0YXJ0RGF0ZVRpbWUoc2VsZWN0ZWRSYW5nZSkge1xuICAgICAgICBsZXQgc3RhcnRUaW1lOiBzdHJpbmc7XG5cbiAgICAgICAgY29uc3QgdGltZXpvbmUgPSB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldFN0b3JhZ2UoJ3RpbWV6b25lJyk7XG5cbiAgICAgICAgc3dpdGNoIChzZWxlY3RlZFJhbmdlKSB7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfSE9VUjpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zdGFydE9mKCdob3VyJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzI0X0hSUzpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zdWJ0cmFjdCgyNCwgJ2hvdXJzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5ZRVNURVJEQVk6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN1YnRyYWN0KDEsICdkYXlzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX0RBWTpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3RhcnRPZignZGF5JykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX1dFRUs6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN0YXJ0T2YoJ3dlZWsnKS5hZGQoMSwgJ2RheXMnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkxBU1RfN19EQVlTOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdWJ0cmFjdCg3LCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9NT05USDpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3RhcnRPZignbW9udGgnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkxBU1RfMzBfREFZUzpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3VidHJhY3QoMzAsICdkYXlzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzEyX01PTlRIUzpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcicpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTEFTVF8xMnRoX01PTlRIOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnN1YnRyYWN0KDEsICd5ZWFyJykuc3RhcnRPZignbW9udGgnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfWUVBUjpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBtb250aDogMCwgZGF0ZTogMSwgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdGFydFRpbWU7XG4gICAgfVxuXG4gICAgZ2V0RW5kRGF0ZVRpbWUoc2VsZWN0ZWRSYW5nZSkge1xuICAgICAgICBsZXQgZW5kVGltZTogc3RyaW5nO1xuXG4gICAgICAgIGNvbnN0IHRpbWV6b25lID0gdGhpcy5zdG9yYWdlU2VydmljZS5nZXRTdG9yYWdlKCd0aW1lem9uZScpO1xuXG4gICAgICAgIHN3aXRjaCAoc2VsZWN0ZWRSYW5nZSkge1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX1RJTUU6XG4gICAgICAgICAgICAgICAgZW5kVGltZSA9IG1vbWVudCgpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9EQVk6XG4gICAgICAgICAgICAgICAgZW5kVGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdGFydE9mKCdkYXknKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLk5FWFRfREFZOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuYWRkKDEsICdkYXlzJykuc3RhcnRPZignZGF5JykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5ORVhUX1dFRUs6XG4gICAgICAgICAgICAgICAgZW5kVGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5hZGQoMSwgJ3dlZWsnKS5zdGFydE9mKCd3ZWVrJykuYWRkKDEsICdkYXlzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5ORVhUX01PTlRIOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuYWRkKDEsICdtb250aHMnKS5zdGFydE9mKCdtb250aCcpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9ZRUFSOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zdGFydE9mKCd5ZWFyJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZW5kVGltZTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRSZXBvcnRpbmdQZXJpb2RMaXN0KG9yZ0lELCBlbmRZZWFyTGVuZ3RoKSB7XG4gICAgICAgIHRoaXMub3JnYW5pemF0aW9uTSA9IDxPcmdhbml6YXRpb25NPmF3YWl0IHRoaXMub3JnYW5pemF0aW9uU2VyaXZlLmdldE9yZ2FuaXphdGlvbkJ5SUQob3JnSUQpO1xuICAgICAgICBsZXQgcmVwb3J0aW5nUGVyaW9kc0xpc3QgPSBbXTtcbiAgICAgICAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBjb25zdCBjdXJyZW50WWVhciA9IGN1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgICAgIGNvbnN0IHN0YXJ0TW9udGggPSB0aGlzLmdldE1vbnRoSW5kZXgodGhpcy5vcmdhbml6YXRpb25NLmZpc2NhbFN0YXJ0TW9udGgpO1xuICAgICAgICBsZXQgZW5kTW9udGggPSAoc3RhcnRNb250aCArIDExKSAlIDEyO1xuXG4gICAgICAgIGZvciAobGV0IHllYXIgPSBjdXJyZW50WWVhcjsgeWVhciA+PSBjdXJyZW50WWVhciAtIGVuZFllYXJMZW5ndGg7IHllYXItLSkge1xuICAgICAgICAgICAgbGV0IHN0YXJ0WWVhciA9IHllYXI7XG4gICAgICAgICAgICBsZXQgZW5kWWVhcjtcbiAgICAgICAgICAgIGlmIChzdGFydE1vbnRoID09IDApIHtcbiAgICAgICAgICAgICAgICBlbmRZZWFyID0gc3RhcnRZZWFyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbmRZZWFyID0gc3RhcnRZZWFyICsgMTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHN0YXJ0WWVhciwgc3RhcnRNb250aCk7XG4gICAgICAgICAgICBsZXQgZW5kRGF0ZSA9IG5ldyBEYXRlKGVuZFllYXIsIGVuZE1vbnRoKTtcblxuICAgICAgICAgICAgbGV0IHN0YXJ0TW9udGhMYWJlbCA9IHN0YXJ0RGF0ZS50b0xvY2FsZVN0cmluZygnZGVmYXVsdCcsIHsgbW9udGg6ICdzaG9ydCcgfSk7XG4gICAgICAgICAgICBsZXQgZW5kTW9udGhMYWJlbCA9IGVuZERhdGUudG9Mb2NhbGVTdHJpbmcoJ2RlZmF1bHQnLCB7IG1vbnRoOiAnc2hvcnQnIH0pO1xuXG4gICAgICAgICAgICBsZXQgcGVyaW9kID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6IGAke3N0YXJ0TW9udGhMYWJlbH0gJHtzdGFydFllYXJ9IC0gJHtlbmRNb250aExhYmVsfSAke2VuZFllYXJ9YCxcbiAgICAgICAgICAgICAgICBzdGFydERhdGU6IG1vbWVudChzdGFydERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIiksXG4gICAgICAgICAgICAgICAgZW5kRGF0ZTogbW9tZW50KGVuZERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIilcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXBvcnRpbmdQZXJpb2RzTGlzdC5wdXNoKHBlcmlvZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcG9ydGluZ1BlcmlvZHNMaXN0O1xuICAgIH1cblxuICAgIGdldE1vbnRoSW5kZXgobW9udGg6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiBNT05USF9DT05TVEFOVC5pbmRleE9mKG1vbnRoKTtcbiAgICB9XG59Il19