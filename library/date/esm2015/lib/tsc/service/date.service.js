import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import * as moment from 'moment-timezone';
import { DateTimeIntervalEnum } from '../enum/date.enum';
import { MONTH_CONSTANT } from '../constant/month.constant';
import { Organization } from '@library/organization-service';
import { COMMON_CONSTANT } from '@library/tsc-common';
import * as i0 from "@angular/core";
import * as i1 from "@library/storage-service";
import * as i2 from "@library/organization-service";
// /tsc-library/
export class DateService {
    constructor(storageService, organizationSerive) {
        this.storageService = storageService;
        this.organizationSerive = organizationSerive;
        this.organizationM = new Organization();
    }
    takeFocusAway(duration) {
        return document.getElementById(duration).classList.remove('mat-focused', 'mat-form-field-should-float');
    }
    openDatepickerOnClick(datepicker) {
        if (!datepicker.opened) {
            datepicker.open();
        }
    }
    handleDateInput(normalizedDate, datepicker, format) {
        datepicker.close();
        return moment(normalizedDate).format(format);
    }
    yearSelectedHandler(normalizedYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedYear).format("YYYY");
        return duration;
    }
    monthSelectedHandler(normalizedMonthAndYear, datepicker) {
        datepicker.close();
        let duration = moment(normalizedMonthAndYear).format("YYYY-MM");
        return duration;
    }
    dailySelectedHandler(selectedDate) {
        let duration = moment(selectedDate).format("YYYY-MM-DD");
        return duration;
    }
    formatDate(selectedDate, format) {
        const date = new Date(selectedDate);
        return moment(date).format(format);
    }
    convertUtcToTimeZone(utcTimeString, targetTimeZone, format) {
        const utcDate = moment(utcTimeString);
        let convertedTimeZone = utcDate.tz(targetTimeZone).format(format);
        return convertedTimeZone;
    }
    getRelativeTimeAgoLabel(dateTime) {
        const timezone = this.storageService.getStorage('timezone');
        return dateTime ? moment.tz(dateTime, timezone).fromNow() : COMMON_CONSTANT.HYPHEN;
    }
    getStartDateTime(selectedRange) {
        let startTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_HOUR:
                startTime = moment().startOf('hour').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_24_HRS:
                startTime = moment().subtract(24, 'hours').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.YESTERDAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_WEEK:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_7_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(7, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_MONTH:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_30_DAYS:
                startTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).subtract(30, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12_MONTHS:
                startTime = moment().subtract(1, 'year').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.LAST_12th_MONTH:
                startTime = moment().subtract(1, 'year').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                startTime = moment().set({ month: 0, date: 1, hour: 0, minute: 0, second: 0, millisecond: 0 }).tz(timezone).format();
                break;
            default:
                startTime = null;
        }
        return startTime;
    }
    getEndDateTime(selectedRange) {
        let endTime;
        const timezone = this.storageService.getStorage('timezone');
        switch (selectedRange) {
            case DateTimeIntervalEnum.CURRENT_TIME:
                endTime = moment().tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_DAY:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'days').startOf('day').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_WEEK:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'week').startOf('week').add(1, 'days').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.NEXT_MONTH:
                endTime = moment().set({ hour: 0, minute: 0, second: 0, millisecond: 0 }).add(1, 'months').startOf('month').tz(timezone).format();
                break;
            case DateTimeIntervalEnum.CURRENT_YEAR:
                endTime = moment().startOf('year').tz(timezone).format();
                break;
            default:
                endTime = null;
        }
        return endTime;
    }
    getReportingPeriodList(orgID, endYearLength) {
        return __awaiter(this, void 0, void 0, function* () {
            this.organizationM = (yield this.organizationSerive.getOrganizationByID(orgID));
            let reportingPeriodsList = [];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const startMonth = this.getMonthIndex(this.organizationM.fiscalStartMonth);
            let endMonth = (startMonth + 11) % 12;
            for (let year = currentYear; year >= currentYear - endYearLength; year--) {
                let startYear = year;
                let endYear;
                if (startMonth == 0) {
                    endYear = startYear;
                }
                else {
                    endYear = startYear + 1;
                }
                let startDate = new Date(startYear, startMonth);
                let endDate = new Date(endYear, endMonth);
                let startMonthLabel = startDate.toLocaleString('default', { month: 'short' });
                let endMonthLabel = endDate.toLocaleString('default', { month: 'short' });
                let period = {
                    name: `${startMonthLabel} ${startYear} - ${endMonthLabel} ${endYear}`,
                    startDate: moment(startDate).format("YYYY-MM-DD"),
                    endDate: moment(endDate).format("YYYY-MM-DD")
                };
                reportingPeriodsList.push(period);
            }
            return reportingPeriodsList;
        });
    }
    getMonthIndex(month) {
        return MONTH_CONSTANT.indexOf(month);
    }
}
DateService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, deps: [{ token: i1.StorageService }, { token: i2.OrganizationService }], target: i0.ɵɵFactoryTarget.Injectable });
DateService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: DateService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.StorageService }, { type: i2.OrganizationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGlicmFyeS9kYXRlL3NyYy9saWIvdHNjL3NlcnZpY2UvZGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE9BQU8sS0FBSyxNQUFNLE1BQU0saUJBQWlCLENBQUM7QUFFMUMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBSTVELE9BQU8sRUFBRSxZQUFZLEVBQXNDLE1BQU0sK0JBQStCLENBQUM7QUFDakcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBQ3RELGdCQUFnQjtBQU1oQixNQUFNLE9BQU8sV0FBVztJQUlwQixZQUNZLGNBQThCLEVBQzlCLGtCQUF1QztRQUR2QyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFxQjtRQUpuRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7SUFLL0IsQ0FBQztJQUVMLGFBQWEsQ0FBQyxRQUFRO1FBQ2xCLE9BQU8sUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSw2QkFBNkIsQ0FBQyxDQUFDO0lBQzVHLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxVQUFpQztRQUNuRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUNwQixVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDckI7SUFDTCxDQUFDO0lBRUQsZUFBZSxDQUFDLGNBQXNCLEVBQUUsVUFBaUMsRUFBRSxNQUFjO1FBQ3JGLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztR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O29CQUNqRCxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7aUJBQ2hELENBQUM7Z0JBQ0Ysb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsT0FBTyxvQkFBb0IsQ0FBQztRQUNoQyxDQUFDO0tBQUE7SUFFRCxhQUFhLENBQUMsS0FBYTtRQUN2QixPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQzs7eUdBektRLFdBQVc7NkdBQVgsV0FBVyxjQUhSLE1BQU07NEZBR1QsV0FBVztrQkFKdkIsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1hdERhdGVwaWNrZXIgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kYXRlcGlja2VyJztcblxuaW1wb3J0IHsgTW9tZW50IH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xuXG5pbXBvcnQgeyBEYXRlVGltZUludGVydmFsRW51bSB9IGZyb20gJy4uL2VudW0vZGF0ZS5lbnVtJztcbmltcG9ydCB7IE1PTlRIX0NPTlNUQU5UIH0gZnJvbSAnLi4vY29uc3RhbnQvbW9udGguY29uc3RhbnQnO1xuXG4vLyB0c2MtbGlicmFyeVxuaW1wb3J0IHsgU3RvcmFnZVNlcnZpY2UgfSBmcm9tICdAbGlicmFyeS9zdG9yYWdlLXNlcnZpY2UnO1xuaW1wb3J0IHsgT3JnYW5pemF0aW9uLCBPcmdhbml6YXRpb25NLCBPcmdhbml6YXRpb25TZXJ2aWNlIH0gZnJvbSAnQGxpYnJhcnkvb3JnYW5pemF0aW9uLXNlcnZpY2UnO1xuaW1wb3J0IHsgQ09NTU9OX0NPTlNUQU5UIH0gZnJvbSAnQGxpYnJhcnkvdHNjLWNvbW1vbic7XG4vLyAvdHNjLWxpYnJhcnkvXG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5cbmV4cG9ydCBjbGFzcyBEYXRlU2VydmljZSB7XG5cbiAgICBvcmdhbml6YXRpb25NID0gbmV3IE9yZ2FuaXphdGlvbigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG9yZ2FuaXphdGlvblNlcml2ZTogT3JnYW5pemF0aW9uU2VydmljZVxuICAgICkgeyB9XG5cbiAgICB0YWtlRm9jdXNBd2F5KGR1cmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChkdXJhdGlvbikuY2xhc3NMaXN0LnJlbW92ZSgnbWF0LWZvY3VzZWQnLCAnbWF0LWZvcm0tZmllbGQtc2hvdWxkLWZsb2F0Jyk7XG4gICAgfVxuXG4gICAgb3BlbkRhdGVwaWNrZXJPbkNsaWNrKGRhdGVwaWNrZXI6IE1hdERhdGVwaWNrZXI8TW9tZW50Pikge1xuICAgICAgICBpZiAoIWRhdGVwaWNrZXIub3BlbmVkKSB7XG4gICAgICAgICAgICBkYXRlcGlja2VyLm9wZW4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGhhbmRsZURhdGVJbnB1dChub3JtYWxpemVkRGF0ZTogTW9tZW50LCBkYXRlcGlja2VyOiBNYXREYXRlcGlja2VyPE1vbWVudD4sIGZvcm1hdDogc3RyaW5nKSB7XG4gICAgICAgIGRhdGVwaWNrZXIuY2xvc2UoKTtcbiAgICAgICAgcmV0dXJuIG1vbWVudChub3JtYWxpemVkRGF0ZSkuZm9ybWF0KGZvcm1hdCk7XG4gICAgfVxuXG4gICAgeWVhclNlbGVjdGVkSGFuZGxlcihub3JtYWxpemVkWWVhcjogTW9tZW50LCBkYXRlcGlja2VyOiBNYXREYXRlcGlja2VyPE1vbWVudD4pIHtcbiAgICAgICAgZGF0ZXBpY2tlci5jbG9zZSgpO1xuICAgICAgICBsZXQgZHVyYXRpb24gPSBtb21lbnQobm9ybWFsaXplZFllYXIpLmZvcm1hdChcIllZWVlcIik7XG4gICAgICAgIHJldHVybiBkdXJhdGlvbjtcbiAgICB9XG5cbiAgICBtb250aFNlbGVjdGVkSGFuZGxlcihub3JtYWxpemVkTW9udGhBbmRZZWFyOiBNb21lbnQsIGRhdGVwaWNrZXI6IE1hdERhdGVwaWNrZXI8TW9tZW50Pikge1xuICAgICAgICBkYXRlcGlja2VyLmNsb3NlKCk7XG4gICAgICAgIGxldCBkdXJhdGlvbiA9IG1vbWVudChub3JtYWxpemVkTW9udGhBbmRZZWFyKS5mb3JtYXQoXCJZWVlZLU1NXCIpO1xuICAgICAgICByZXR1cm4gZHVyYXRpb247XG4gICAgfVxuXG4gICAgZGFpbHlTZWxlY3RlZEhhbmRsZXIoc2VsZWN0ZWREYXRlOiBNb21lbnQpIHtcbiAgICAgICAgbGV0IGR1cmF0aW9uID0gbW9tZW50KHNlbGVjdGVkRGF0ZSkuZm9ybWF0KFwiWVlZWS1NTS1ERFwiKTtcbiAgICAgICAgcmV0dXJuIGR1cmF0aW9uO1xuICAgIH1cblxuICAgIGZvcm1hdERhdGUoc2VsZWN0ZWREYXRlOiBzdHJpbmcsIGZvcm1hdDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShzZWxlY3RlZERhdGUpO1xuICAgICAgICByZXR1cm4gbW9tZW50KGRhdGUpLmZvcm1hdChmb3JtYXQpO1xuICAgIH1cblxuICAgIGNvbnZlcnRVdGNUb1RpbWVab25lKHV0Y1RpbWVTdHJpbmc6IHN0cmluZywgdGFyZ2V0VGltZVpvbmU6IHN0cmluZywgZm9ybWF0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdXRjRGF0ZSA9IG1vbWVudCh1dGNUaW1lU3RyaW5nKTtcbiAgICAgICAgbGV0IGNvbnZlcnRlZFRpbWVab25lID0gdXRjRGF0ZS50eih0YXJnZXRUaW1lWm9uZSkuZm9ybWF0KGZvcm1hdCk7XG4gICAgICAgIHJldHVybiBjb252ZXJ0ZWRUaW1lWm9uZTtcbiAgICB9XG5cbiAgICBnZXRSZWxhdGl2ZVRpbWVBZ29MYWJlbChkYXRlVGltZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgdGltZXpvbmUgPSB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldFN0b3JhZ2UoJ3RpbWV6b25lJyk7XG5cbiAgICAgICAgcmV0dXJuIGRhdGVUaW1lID8gbW9tZW50LnR6KGRhdGVUaW1lLCB0aW1lem9uZSkuZnJvbU5vdygpIDogQ09NTU9OX0NPTlNUQU5ULkhZUEhFTjtcbiAgICB9XG5cbiAgICBnZXRTdGFydERhdGVUaW1lKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgbGV0IHN0YXJ0VGltZTogc3RyaW5nO1xuXG4gICAgICAgIGNvbnN0IHRpbWV6b25lID0gdGhpcy5zdG9yYWdlU2VydmljZS5nZXRTdG9yYWdlKCd0aW1lem9uZScpO1xuXG4gICAgICAgIHN3aXRjaCAoc2VsZWN0ZWRSYW5nZSkge1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX0hPVVI6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3RhcnRPZignaG91cicpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTEFTVF8yNF9IUlM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3VidHJhY3QoMjQsICdob3VycycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uWUVTVEVSREFZOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdWJ0cmFjdCgxLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9EQVk6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN0YXJ0T2YoJ2RheScpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9XRUVLOlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG1vbWVudCgpLnNldCh7IGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS5zdGFydE9mKCd3ZWVrJykuYWRkKDEsICdkYXlzJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzdfREFZUzpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3VidHJhY3QoNywgJ2RheXMnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfTU9OVEg6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN0YXJ0T2YoJ21vbnRoJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5MQVNUXzMwX0RBWVM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLnN1YnRyYWN0KDMwLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTEFTVF8xMl9NT05USFM6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc3VidHJhY3QoMSwgJ3llYXInKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkxBU1RfMTJ0aF9NT05USDpcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcicpLnN0YXJ0T2YoJ21vbnRoJykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5DVVJSRU5UX1lFQVI6XG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbW9tZW50KCkuc2V0KHsgbW9udGg6IDAsIGRhdGU6IDEsIGhvdXI6IDAsIG1pbnV0ZTogMCwgc2Vjb25kOiAwLCBtaWxsaXNlY29uZDogMCB9KS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3RhcnRUaW1lO1xuICAgIH1cblxuICAgIGdldEVuZERhdGVUaW1lKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgbGV0IGVuZFRpbWU6IHN0cmluZztcblxuICAgICAgICBjb25zdCB0aW1lem9uZSA9IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0U3RvcmFnZSgndGltZXpvbmUnKTtcblxuICAgICAgICBzd2l0Y2ggKHNlbGVjdGVkUmFuZ2UpIHtcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uQ1VSUkVOVF9USU1FOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfREFZOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuc3RhcnRPZignZGF5JykudHoodGltZXpvbmUpLmZvcm1hdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBEYXRlVGltZUludGVydmFsRW51bS5ORVhUX0RBWTpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLmFkZCgxLCAnZGF5cycpLnN0YXJ0T2YoJ2RheScpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTkVYVF9XRUVLOlxuICAgICAgICAgICAgICAgIGVuZFRpbWUgPSBtb21lbnQoKS5zZXQoeyBob3VyOiAwLCBtaW51dGU6IDAsIHNlY29uZDogMCwgbWlsbGlzZWNvbmQ6IDAgfSkuYWRkKDEsICd3ZWVrJykuc3RhcnRPZignd2VlaycpLmFkZCgxLCAnZGF5cycpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRGF0ZVRpbWVJbnRlcnZhbEVudW0uTkVYVF9NT05USDpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc2V0KHsgaG91cjogMCwgbWludXRlOiAwLCBzZWNvbmQ6IDAsIG1pbGxpc2Vjb25kOiAwIH0pLmFkZCgxLCAnbW9udGhzJykuc3RhcnRPZignbW9udGgnKS50eih0aW1lem9uZSkuZm9ybWF0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIERhdGVUaW1lSW50ZXJ2YWxFbnVtLkNVUlJFTlRfWUVBUjpcbiAgICAgICAgICAgICAgICBlbmRUaW1lID0gbW9tZW50KCkuc3RhcnRPZigneWVhcicpLnR6KHRpbWV6b25lKS5mb3JtYXQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgZW5kVGltZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVuZFRpbWU7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0UmVwb3J0aW5nUGVyaW9kTGlzdChvcmdJRCwgZW5kWWVhckxlbmd0aCkge1xuICAgICAgICB0aGlzLm9yZ2FuaXphdGlvbk0gPSA8T3JnYW5pemF0aW9uTT5hd2FpdCB0aGlzLm9yZ2FuaXphdGlvblNlcml2ZS5nZXRPcmdhbml6YXRpb25CeUlEKG9yZ0lEKTtcbiAgICAgICAgbGV0IHJlcG9ydGluZ1BlcmlvZHNMaXN0ID0gW107XG4gICAgICAgIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29uc3QgY3VycmVudFllYXIgPSBjdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICBjb25zdCBzdGFydE1vbnRoID0gdGhpcy5nZXRNb250aEluZGV4KHRoaXMub3JnYW5pemF0aW9uTS5maXNjYWxTdGFydE1vbnRoKTtcbiAgICAgICAgbGV0IGVuZE1vbnRoID0gKHN0YXJ0TW9udGggKyAxMSkgJSAxMjtcblxuICAgICAgICBmb3IgKGxldCB5ZWFyID0gY3VycmVudFllYXI7IHllYXIgPj0gY3VycmVudFllYXIgLSBlbmRZZWFyTGVuZ3RoOyB5ZWFyLS0pIHtcbiAgICAgICAgICAgIGxldCBzdGFydFllYXIgPSB5ZWFyO1xuICAgICAgICAgICAgbGV0IGVuZFllYXI7XG4gICAgICAgICAgICBpZiAoc3RhcnRNb250aCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgZW5kWWVhciA9IHN0YXJ0WWVhcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZW5kWWVhciA9IHN0YXJ0WWVhciArIDE7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBzdGFydERhdGUgPSBuZXcgRGF0ZShzdGFydFllYXIsIHN0YXJ0TW9udGgpO1xuICAgICAgICAgICAgbGV0IGVuZERhdGUgPSBuZXcgRGF0ZShlbmRZZWFyLCBlbmRNb250aCk7XG5cbiAgICAgICAgICAgIGxldCBzdGFydE1vbnRoTGFiZWwgPSBzdGFydERhdGUudG9Mb2NhbGVTdHJpbmcoJ2RlZmF1bHQnLCB7IG1vbnRoOiAnc2hvcnQnIH0pO1xuICAgICAgICAgICAgbGV0IGVuZE1vbnRoTGFiZWwgPSBlbmREYXRlLnRvTG9jYWxlU3RyaW5nKCdkZWZhdWx0JywgeyBtb250aDogJ3Nob3J0JyB9KTtcblxuICAgICAgICAgICAgbGV0IHBlcmlvZCA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBgJHtzdGFydE1vbnRoTGFiZWx9ICR7c3RhcnRZZWFyfSAtICR7ZW5kTW9udGhMYWJlbH0gJHtlbmRZZWFyfWAsXG4gICAgICAgICAgICAgICAgc3RhcnREYXRlOiBtb21lbnQoc3RhcnREYXRlKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpLFxuICAgICAgICAgICAgICAgIGVuZERhdGU6IG1vbWVudChlbmREYXRlKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmVwb3J0aW5nUGVyaW9kc0xpc3QucHVzaChwZXJpb2QpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXBvcnRpbmdQZXJpb2RzTGlzdDtcbiAgICB9XG5cbiAgICBnZXRNb250aEluZGV4KG1vbnRoOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gTU9OVEhfQ09OU1RBTlQuaW5kZXhPZihtb250aCk7XG4gICAgfVxufSJdfQ==