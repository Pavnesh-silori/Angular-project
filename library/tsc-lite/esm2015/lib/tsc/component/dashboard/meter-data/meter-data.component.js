import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { FormControl } from '@angular/forms';
import { DashboardErrorEnum } from '../../../enum/error.enum';
import { DevicesWithEntities } from '../../../model/device.model';
import { Parameter } from '../../../model/parameter.model';
import { Alert } from '../../../model/alert.model';
import { RecentDataRequestWithParam } from '../../../model/recent-data.model';
import { COMMON_CONSTANT, FormErrorEnum, MatSelectSearchService, MaterialFormFieldAppearance, MessageAlertIconEnum, MessageAlertTypeEnum } from '@library/tsc-common';
import { ApplicationKeyID } from '@library/application-service';
import * as i0 from "@angular/core";
import * as i1 from "@library/storage-service";
import * as i2 from "../../../service/recent-data.service";
import * as i3 from "../../../service/entity-device.service";
import * as i4 from "../../../service/parameter.service";
import * as i5 from "../../../service/alert.service";
import * as i6 from "@library/date";
import * as i7 from "../../../service/trend.service";
import * as i8 from "@angular/material/form-field";
import * as i9 from "@angular/material/select";
import * as i10 from "@angular/material/core";
import * as i11 from "ngx-mat-select-search";
import * as i12 from "@library/tsc-common";
import * as i13 from "@angular/material/card";
import * as i14 from "@angular/forms";
import * as i15 from "@angular/common";
import * as i16 from "@angular/material/tooltip";
// /tsc-library/
export class MeterDataDashboardComponent {
    constructor(storageService, recentDataService, entityDeviceService, parameterService, alertService, dateService, trendService) {
        this.storageService = storageService;
        this.recentDataService = recentDataService;
        this.entityDeviceService = entityDeviceService;
        this.parameterService = parameterService;
        this.alertService = alertService;
        this.dateService = dateService;
        this.trendService = trendService;
        this.COMMON_CONSTANT = COMMON_CONSTANT;
        this.MaterialFormFieldAppearance = MaterialFormFieldAppearance;
        this.FormErrorEnum = FormErrorEnum;
        this.last48HrsMeterData = {};
        this.showAlert = false;
        this.showLoader = false;
        this.entityDeviceM = [new DevicesWithEntities()];
        this.parameterM = [new Parameter()];
        this.alertObj = new Alert();
        this.meterFC = new FormControl();
        this.meterSearchUtil = new MatSelectSearchService(['name']);
    }
    ngOnInit() {
        this.orgID = this.storageService.getStorage('currentOrgID');
        this.timezone = this.storageService.getStorage('timezone');
        this.applicationKeyID = this.storageService.getStorage('applicationKeyID');
        if (this.applicationKeyID == ApplicationKeyID.ENERGY_KEY_ID) {
            this.paramMetric = "engEnergyUsed";
        }
        else if (this.applicationKeyID == ApplicationKeyID.WATER_KEY_ID) {
            this.paramMetric = "gwFlowTotalizer";
        }
        this.getDevicesWithEntitiesByParameter();
    }
    getDevicesWithEntitiesByParameter() {
        var _a, _b, _c, _d, _e, _f;
        return __awaiter(this, void 0, void 0, function* () {
            this.entityDeviceM = (yield this.entityDeviceService.getDevicesWithEntitiesByParameter(this.orgID, this.paramMetric));
            this.meterSearchUtil.entityArr = this.entityDeviceM;
            this.meterSearchUtil.createSubscription();
            if (this.entityDeviceM.length > 0 && ((_b = (_a = this.entityDeviceM) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.id)) {
                const deviceID = (_f = (_e = (_d = (_c = this.entityDeviceM) === null || _c === void 0 ? void 0 : _c[0]) === null || _d === void 0 ? void 0 : _d['devices']) === null || _e === void 0 ? void 0 : _e[0]) === null || _f === void 0 ? void 0 : _f['id'];
                this.meterFC.patchValue(deviceID);
                this.getParameterList();
            }
        });
    }
    meterChange(selectedMeter) {
        clearTimeout(this.apiTimer);
        this.showLoader = true;
        this.meterFC.patchValue(selectedMeter);
        this.getParameterList();
    }
    getParameterList() {
        const selectedMeter = this.meterFC.value;
        this.getParameterByDeviceID(selectedMeter);
    }
    getParameterByDeviceID(deviceID) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            let requestBody = {};
            requestBody['deviceID'] = [deviceID];
            this.parameterM = (yield this.parameterService.getParameterByDeviceID(this.orgID, requestBody));
            if (this.parameterM.length > 0 && ((_b = (_a = this.parameterM) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.id)) {
                this.getRecentMeterData(deviceID);
            }
        });
    }
    getRecentMeterData(deviceID) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            this.alertService.resetAlertProperties(this.alertObj);
            try {
                let requestData = new RecentDataRequestWithParam();
                requestData.params = this.parameterM.map(param => ({ name: param.paramMetric }));
                requestData.deviceID = [deviceID];
                requestData.backscan = 1;
                requestData.timezone = this.timezone;
                this.meterDataRes = yield this.recentDataService.getRecentDataWithParam(this.orgID, requestData);
                if (((_a = this.meterDataRes) === null || _a === void 0 ? void 0 : _a.length) == 0) {
                    this.alertService.setAlertProperties(this.alertObj, DashboardErrorEnum.DATA_NOT_FOUND_LABEL, DashboardErrorEnum.DATA_NOT_FOUND_MESSAGE, MessageAlertTypeEnum.WARNING, MessageAlertIconEnum.WARNING_ICON);
                }
            }
            catch (error) {
                console.error(`Error in getRecentMeterData()`, error);
                this.alertService.setAlertProperties(this.alertObj, DashboardErrorEnum.INVALID_ERROR_LABEL, DashboardErrorEnum.INVALID_ERROR_MESSAGE, MessageAlertTypeEnum.DANGER, MessageAlertIconEnum.DANGER_ICON);
            }
            finally {
                this.apiTimer = setTimeout(() => {
                    this.getRecentMeterData(deviceID);
                }, 300000);
                this.showLoader = false;
            }
        });
    }
    getLast48HrsMeterData(paramName) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                let requestData = new RecentDataRequestWithParam();
                requestData.params = [{ name: paramName }];
                requestData.deviceID = [this.meterFC.value];
                requestData.backscan = 48;
                requestData.timezone = this.timezone;
                const result = yield this.recentDataService.getRecentDataWithParam(this.orgID, requestData);
                if (result.length > 0) {
                    this.last48HrsMeterData[paramName] = result[0];
                }
                else {
                    this.last48HrsMeterData[paramName] = null;
                }
                this.currentParamName = paramName;
            }
            catch (error) {
                console.error(`Error in getLast48HrsMeterData()`, error);
            }
        });
    }
    showTrend(paramMetric, entityID) {
        let requestBody = {
            paramMetric: paramMetric,
            entityID: entityID,
            deviceID: this.meterFC.value
        };
        this.trendService.openDialog(requestBody);
    }
    ngOnDestroy() {
        clearTimeout(this.apiTimer);
    }
}
MeterDataDashboardComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: MeterDataDashboardComponent, deps: [{ token: i1.StorageService }, { token: i2.RecentDataService }, { token: i3.EntityDeviceService }, { token: i4.ParameterService }, { token: i5.AlertService }, { token: i6.DateService }, { token: i7.TrendService }], target: i0.ɵɵFactoryTarget.Component });
MeterDataDashboardComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: MeterDataDashboardComponent, selector: "lib-meter-data", ngImport: i0, template: "<div class=\"card main-card cardOverwrite h100\">\n    <div class=\"headerContainer\">\n        <div class=\"headerLeftContainer\">\n            <div class=\"pageTitle\">Meter Data Dashboard</div>\n        </div>\n    </div>\n\n    <div class=\"card-body\">\n        <div class=\"row\">\n            <div class=\"col-sm-3\">\n                <mat-form-field class=\"matFieldWidth100\"\n                    [appearance]=\"MaterialFormFieldAppearance.FORM_FIELD_APPEARANCE\">\n                    <mat-label>Select meter</mat-label>\n                    <mat-select (selectionChange)=\"meterChange($event.value)\" [formControl]=\"meterFC\" required>\n                        <ng-container\n                            *ngIf=\"entityDeviceM && entityDeviceM.length > 0 && entityDeviceM?.[0]?.id; else noDataFound\">\n                            <mat-option>\n                                <ngx-mat-select-search [formControl]=\"meterSearchUtil.filterFC\"\n                                    placeholderLabel=\"Search by entity name\"\n                                    noEntriesFoundLabel=\"No matching name found.\">\n                                </ngx-mat-select-search>\n                            </mat-option>\n                            <mat-optgroup *ngFor=\"let entity of meterSearchUtil.filteredEntities | async\"\n                                [label]=\"entity.name\" [disabled]=\"entity.disabled\">\n                                <mat-option *ngFor=\"let device of entity.devices\" [value]=\"device.id\">\n                                    {{ device.name }}\n                                </mat-option>\n                            </mat-optgroup>\n                        </ng-container>\n                        <ng-template #noDataFound>\n                            <mat-option disabled>\n                                {{ COMMON_CONSTANT.NO_DATA_FOUND }}\n                            </mat-option>\n                        </ng-template>\n                    </mat-select>\n                    <mat-error *ngIf=\"meterFC.touched && meterFC.hasError('required')\">\n                        {{ FormErrorEnum.REQUIRED }}\n                    </mat-error>\n                </mat-form-field>\n            </div>\n        </div>\n\n        <div class=\"row mt-2\">\n            <div class=\"col-sm-12\">\n                <lib-message-alert *ngIf=\"alertObj.showAlert\" [labelInp]=\"alertObj.alertLabel\"\n                    [contentInp]=\"alertObj.alertContent\" [messageAlertTypeInp]=\"alertObj.messageAlertType\"\n                    [messageAlertIconInp]=\"alertObj.messageAlertIcon\">\n                </lib-message-alert>\n            </div>\n        </div>\n\n        <div class=\"row mt-2\">\n            <ng-container *ngIf=\"showLoader; else dataTemplate\">\n                <lib-skeleton-loader [count]=\"3\" [appearance]=\"''\"\n                    [theme]=\"{ 'border-radius': '16px', height: '40px', 'background-color': 'rgb(230 232 235)' }\"></lib-skeleton-loader>\n            </ng-container>\n            <ng-template #dataTemplate>\n                <div class=\"col-sm-4 mb-3\" *ngFor=\"let meterData of meterDataRes\">\n                    <mat-card class=\"cardOverwrite cardBackgroundColor\">\n                        <ng-container *ngTemplateOutlet=\"parameterData; context: {\n                            duration: last48HrsMeterData && last48HrsMeterData[meterData.paramName]?.data?.date ? dateService.getRelativeTimeAgoLabel(last48HrsMeterData[meterData.paramName]?.data?.date, timezone) : dateService.getRelativeTimeAgoLabel(meterData?.data?.date, timezone),\n                            value: last48HrsMeterData && last48HrsMeterData[meterData.paramName]?.data?.value != null ? last48HrsMeterData[meterData.paramName]?.data?.value : meterData?.data?.value,\n                            unit: meterData?.unit,\n                            label: meterData?.paramLabel,\n                            entityID: meterData?.entityID,\n                            paramName: meterData?.paramName,\n                            status: meterData?.status\n                        }\"></ng-container>\n                    </mat-card>\n                </div>\n            </ng-template>\n        </div>\n\n    </div>\n</div>\n\n<ng-template #parameterData let-duration=\"duration\" let-label=\"label\" let-value=\"value\" let-unit=\"unit\"\n    let-entityID=\"entityID\" let-paramName=\"paramName\" let-status=\"status\">\n    <div class=\"row\">\n        <div class=\"col-sm-6 textDurationWithAgoTime\">\n            {{ duration }}\n        </div>\n        <div class=\"col-sm-6 text-end\">\n            <a *ngIf=\"status == 'OFFLINE'\" class=\"text-secondary cursorPointer me-2\"\n                matTooltip=\"Currently parameter is offline, click here to see data of last 48 hrs.\"\n                matTooltipPosition=\"below\" (click)=\"getLast48HrsMeterData(paramName)\">\n                <span class=\"material-symbols-outlined fs-5 fw-bold\">devices</span>\n            </a>\n            <a class=\"text-primary cursorPointer\" matTooltip=\"Trend\" matTooltipPosition=\"below\"\n                (click)=\"showTrend(paramName, entityID)\">\n                <span class=\"material-symbols-outlined fs-5 fw-bold\">trending_up</span>\n            </a>\n        </div>\n    </div>\n    <div class=\"row mt-3\">\n        <div class=\"col-sm-12 text-center\">\n            <span class=\"fs-1 fw-bold text-primary\">{{ value != null && value != undefined ? (value | number: '1.2-2' ||\n                COMMON_CONSTANT.HYPHEN) : COMMON_CONSTANT.HYPHEN }}</span>\n            <span class=\"text-secondary fw-bold\"> {{ value ? unit : '' }} </span>\n        </div>\n    </div>\n    <div class=\"row mt-4 mb-4\">\n        <div class=\"col-sm-12 fs-5 text-center\">\n            {{ label }}\n        </div>\n    </div>\n</ng-template>", components: [{ type: i8.MatFormField, selector: "mat-form-field", inputs: ["color", "floatLabel", "appearance", "hideRequiredMarker", "hintLabel"], exportAs: ["matFormField"] }, { type: i9.MatSelect, selector: "mat-select", inputs: ["disabled", "disableRipple", "tabIndex"], exportAs: ["matSelect"] }, { type: i10.MatOption, selector: "mat-option", exportAs: ["matOption"] }, { type: i11.MatSelectSearchComponent, selector: "ngx-mat-select-search", inputs: ["placeholderLabel", "type", "closeIcon", "closeSvgIcon", "noEntriesFoundLabel", "indexAndLengthScreenReaderText", "clearSearchInput", "searching", "disableInitialFocus", "enableClearOnEscapePressed", "preventHomeEndKeyPropagation", "disableScrollToActiveOnOptionsChanged", "ariaLabel", "showToggleAllCheckbox", "toggleAllCheckboxChecked", "toggleAllCheckboxIndeterminate", "toggleAllCheckboxTooltipMessage", "toogleAllCheckboxTooltipPosition", "hideClearSearchButton", "alwaysRestoreSelectedOptionsMulti"], outputs: ["toggleAll"] }, { type: i10.MatOptgroup, selector: "mat-optgroup", inputs: ["disabled"], exportAs: ["matOptgroup"] }, { type: i12.MessageAlertComponent, selector: "lib-message-alert", inputs: ["messageAlertTypeInp", "messageAlertIconInp", "labelInp", "contentInp", "showCloseBtnInp"] }, { type: i12.SkeletonComponent, selector: "lib-skeleton-loader", inputs: ["count", "appearance", "theme"] }, { type: i13.MatCard, selector: "mat-card", exportAs: ["matCard"] }], directives: [{ type: i8.MatLabel, selector: "mat-label" }, { type: i14.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }, { type: i14.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i14.FormControlDirective, selector: "[formControl]", inputs: ["disabled", "formControl", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }, { type: i15.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i15.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i8.MatError, selector: "mat-error", inputs: ["id"] }, { type: i15.NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet"] }, { type: i16.MatTooltip, selector: "[matTooltip]", exportAs: ["matTooltip"] }], pipes: { "async": i15.AsyncPipe, "number": i15.DecimalPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: MeterDataDashboardComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'lib-meter-data',
                    templateUrl: './meter-data.component.html',
                    styles: []
                }]
        }], ctorParameters: function () { return [{ type: i1.StorageService }, { type: i2.RecentDataService }, { type: i3.EntityDeviceService }, { type: i4.ParameterService }, { type: i5.AlertService }, { type: i6.DateService }, { type: i7.TrendService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0ZXItZGF0YS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9saWJyYXJ5L3RzYy1saXRlL3NyYy9saWIvdHNjL2NvbXBvbmVudC9kYXNoYm9hcmQvbWV0ZXItZGF0YS9tZXRlci1kYXRhLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2xpYnJhcnkvdHNjLWxpdGUvc3JjL2xpYi90c2MvY29tcG9uZW50L2Rhc2hib2FyZC9tZXRlci1kYXRhL21ldGVyLWRhdGEuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTlELE9BQU8sRUFBRSxtQkFBbUIsRUFBd0IsTUFBTSw2QkFBNkIsQ0FBQztBQUN4RixPQUFPLEVBQUUsU0FBUyxFQUFjLE1BQU0sZ0NBQWdDLENBQUM7QUFDdkUsT0FBTyxFQUFFLEtBQUssRUFBVSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBVTlFLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLDJCQUEyQixFQUFFLG9CQUFvQixFQUFFLG9CQUFvQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdEssT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNoRSxnQkFBZ0I7QUFRaEIsTUFBTSxPQUFPLDJCQUEyQjtJQTJCcEMsWUFDWSxjQUE4QixFQUM5QixpQkFBb0MsRUFDcEMsbUJBQXdDLEVBQ3hDLGdCQUFrQyxFQUNsQyxZQUEwQixFQUMzQixXQUF3QixFQUN2QixZQUEwQjtRQU4xQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDM0IsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDdkIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFoQ3RDLG9CQUFlLEdBQUcsZUFBZSxDQUFDO1FBRWxDLGdDQUEyQixHQUFHLDJCQUEyQixDQUFDO1FBQzFELGtCQUFhLEdBQUcsYUFBYSxDQUFDO1FBUTlCLHVCQUFrQixHQUEyQixFQUFFLENBQUM7UUFHaEQsY0FBUyxHQUFZLEtBQUssQ0FBQztRQUMzQixlQUFVLEdBQVksS0FBSyxDQUFDO1FBRTVCLGtCQUFhLEdBQUcsQ0FBQyxJQUFJLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUM1QyxlQUFVLEdBQUcsQ0FBQyxJQUFJLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDL0IsYUFBUSxHQUFXLElBQUksS0FBSyxFQUFFLENBQUM7UUFFL0IsWUFBTyxHQUFnQixJQUFJLFdBQVcsRUFBRSxDQUFDO1FBRXpDLG9CQUFlLEdBQTJCLElBQUksc0JBQXNCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBVTNFLENBQUM7SUFFTCxRQUFRO1FBQ0osSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBRTNFLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLGFBQWEsRUFBRTtZQUN6RCxJQUFJLENBQUMsV0FBVyxHQUFHLGVBQWUsQ0FBQztTQUN0QzthQUFNLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLFlBQVksRUFBRTtZQUMvRCxJQUFJLENBQUMsV0FBVyxHQUFHLGlCQUFpQixDQUFDO1NBQ3hDO1FBRUQsSUFBSSxDQUFDLGlDQUFpQyxFQUFFLENBQUM7SUFDN0MsQ0FBQztJQUVLLGlDQUFpQzs7O1lBQ25DLElBQUksQ0FBQyxhQUFhLElBQTJCLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBLENBQUM7WUFFNUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztZQUNwRCxJQUFJLENBQUMsZUFBZSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFFMUMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUksTUFBQSxNQUFBLElBQUksQ0FBQyxhQUFhLDBDQUFHLENBQUMsQ0FBQywwQ0FBRSxFQUFFLENBQUEsRUFBRTtnQkFDOUQsTUFBTSxRQUFRLEdBQUcsTUFBQSxNQUFBLE1BQUEsTUFBQSxJQUFJLENBQUMsYUFBYSwwQ0FBRyxDQUFDLENBQUMsMENBQUcsU0FBUyxDQUFDLDBDQUFHLENBQUMsQ0FBQywwQ0FBRyxJQUFJLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBRWxDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO2FBQzNCOztLQUNKO0lBRUQsV0FBVyxDQUFDLGFBQWE7UUFDckIsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUV2QixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsZ0JBQWdCO1FBQ1osTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDekMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFSyxzQkFBc0IsQ0FBQyxRQUFROzs7WUFDakMsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO1lBQ3JCLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXJDLElBQUksQ0FBQyxVQUFVLElBQWlCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUEsQ0FBQztZQUU1RyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsS0FBSSxNQUFBLE1BQUEsSUFBSSxDQUFDLFVBQVUsMENBQUcsQ0FBQyxDQUFDLDBDQUFFLEVBQUUsQ0FBQSxFQUFFO2dCQUN4RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDckM7O0tBQ0o7SUFFSyxrQkFBa0IsQ0FBQyxRQUFROzs7WUFFN0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFdEQsSUFBSTtnQkFDQSxJQUFJLFdBQVcsR0FBRyxJQUFJLDBCQUEwQixFQUFFLENBQUM7Z0JBRW5ELFdBQVcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pGLFdBQVcsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbEMsV0FBVyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7Z0JBQ3pCLFdBQVcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFFckMsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUVqRyxJQUFJLENBQUEsTUFBQSxJQUFJLENBQUMsWUFBWSwwQ0FBRSxNQUFNLEtBQUksQ0FBQyxFQUFFO29CQUNoQyxJQUFJLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsa0JBQWtCLENBQUMsb0JBQW9CLEVBQUUsa0JBQWtCLENBQUMsc0JBQXNCLEVBQUUsb0JBQW9CLENBQUMsT0FBTyxFQUFFLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxDQUFDO2lCQUM1TTthQUVKO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDdEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGtCQUFrQixDQUFDLG1CQUFtQixFQUFFLGtCQUFrQixDQUFDLHFCQUFxQixFQUFFLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN4TTtvQkFBUztnQkFDTixJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7b0JBQzVCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDdEMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNYLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO2FBQzNCOztLQUNKO0lBRUsscUJBQXFCLENBQUMsU0FBUzs7WUFDakMsSUFBSTtnQkFDQSxJQUFJLFdBQVcsR0FBRyxJQUFJLDBCQUEwQixFQUFFLENBQUM7Z0JBRW5ELFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQyxXQUFXLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDNUMsV0FBVyxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7Z0JBQzFCLFdBQVcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFFckMsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFFNUYsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDbkIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDbEQ7cUJBQU07b0JBQ0gsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQztpQkFDN0M7Z0JBQ0QsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQzthQUVyQztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDNUQ7UUFDTCxDQUFDO0tBQUE7SUFFRCxTQUFTLENBQUMsV0FBVyxFQUFFLFFBQVE7UUFDM0IsSUFBSSxXQUFXLEdBQUc7WUFDZCxXQUFXLEVBQUUsV0FBVztZQUN4QixRQUFRLEVBQUUsUUFBUTtZQUNsQixRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLO1NBQy9CLENBQUM7UUFDRixJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsV0FBVztRQUNQLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQzs7eUhBeEpRLDJCQUEyQjs2R0FBM0IsMkJBQTJCLHNEQzdCeEMsZ3ZMQTBHYzs0RkQ3RUQsMkJBQTJCO2tCQU52QyxTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLFdBQVcsRUFBRSw2QkFBNkI7b0JBQzFDLE1BQU0sRUFBRSxFQUNQO2lCQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBEYXNoYm9hcmRFcnJvckVudW0gfSBmcm9tICcuLi8uLi8uLi9lbnVtL2Vycm9yLmVudW0nO1xuXG5pbXBvcnQgeyBEZXZpY2VzV2l0aEVudGl0aWVzLCBEZXZpY2VzV2l0aEVudGl0aWVzTSB9IGZyb20gJy4uLy4uLy4uL21vZGVsL2RldmljZS5tb2RlbCc7XG5pbXBvcnQgeyBQYXJhbWV0ZXIsIFBhcmFtZXRlck0gfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9wYXJhbWV0ZXIubW9kZWwnO1xuaW1wb3J0IHsgQWxlcnQsIEFsZXJ0TSB9IGZyb20gJy4uLy4uLy4uL21vZGVsL2FsZXJ0Lm1vZGVsJztcbmltcG9ydCB7IFJlY2VudERhdGFSZXF1ZXN0V2l0aFBhcmFtIH0gZnJvbSAnLi4vLi4vLi4vbW9kZWwvcmVjZW50LWRhdGEubW9kZWwnO1xuXG5pbXBvcnQgeyBSZWNlbnREYXRhU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2UvcmVjZW50LWRhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBQYXJhbWV0ZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZS9wYXJhbWV0ZXIuc2VydmljZSc7XG5pbXBvcnQgeyBFbnRpdHlEZXZpY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZS9lbnRpdHktZGV2aWNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZS9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IFRyZW5kU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2UvdHJlbmQuc2VydmljZSc7XG5cbi8vIHRzYy1saWJyYXJ5XG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJ0BsaWJyYXJ5L3N0b3JhZ2Utc2VydmljZSc7XG5pbXBvcnQgeyBDT01NT05fQ09OU1RBTlQsIEZvcm1FcnJvckVudW0sIE1hdFNlbGVjdFNlYXJjaFNlcnZpY2UsIE1hdGVyaWFsRm9ybUZpZWxkQXBwZWFyYW5jZSwgTWVzc2FnZUFsZXJ0SWNvbkVudW0sIE1lc3NhZ2VBbGVydFR5cGVFbnVtIH0gZnJvbSAnQGxpYnJhcnkvdHNjLWNvbW1vbic7XG5pbXBvcnQgeyBEYXRlU2VydmljZSB9IGZyb20gJ0BsaWJyYXJ5L2RhdGUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25LZXlJRCB9IGZyb20gJ0BsaWJyYXJ5L2FwcGxpY2F0aW9uLXNlcnZpY2UnO1xuLy8gL3RzYy1saWJyYXJ5L1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2xpYi1tZXRlci1kYXRhJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vbWV0ZXItZGF0YS5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVzOiBbXG4gICAgXVxufSlcbmV4cG9ydCBjbGFzcyBNZXRlckRhdGFEYXNoYm9hcmRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgQ09NTU9OX0NPTlNUQU5UID0gQ09NTU9OX0NPTlNUQU5UO1xuXG4gICAgTWF0ZXJpYWxGb3JtRmllbGRBcHBlYXJhbmNlID0gTWF0ZXJpYWxGb3JtRmllbGRBcHBlYXJhbmNlO1xuICAgIEZvcm1FcnJvckVudW0gPSBGb3JtRXJyb3JFbnVtO1xuXG4gICAgb3JnSUQ6IGFueTtcbiAgICBhcHBsaWNhdGlvbktleUlEOiBhbnk7XG4gICAgcGFyYW1NZXRyaWM6IGFueTtcbiAgICBlbnRpdHlJRDogYW55O1xuICAgIHRpbWV6b25lOiBzdHJpbmc7XG4gICAgbWV0ZXJEYXRhUmVzOiBhbnk7XG4gICAgbGFzdDQ4SHJzTWV0ZXJEYXRhOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG4gICAgY3VycmVudFBhcmFtTmFtZTogYW55O1xuICAgIGFwaVRpbWVyOiBhbnk7XG4gICAgc2hvd0FsZXJ0OiBib29sZWFuID0gZmFsc2U7XG4gICAgc2hvd0xvYWRlcjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgZW50aXR5RGV2aWNlTSA9IFtuZXcgRGV2aWNlc1dpdGhFbnRpdGllcygpXTtcbiAgICBwYXJhbWV0ZXJNID0gW25ldyBQYXJhbWV0ZXIoKV07XG4gICAgYWxlcnRPYmo6IEFsZXJ0TSA9IG5ldyBBbGVydCgpO1xuXG4gICAgbWV0ZXJGQzogRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woKTtcblxuICAgIG1ldGVyU2VhcmNoVXRpbDogTWF0U2VsZWN0U2VhcmNoU2VydmljZSA9IG5ldyBNYXRTZWxlY3RTZWFyY2hTZXJ2aWNlKFsnbmFtZSddKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHN0b3JhZ2VTZXJ2aWNlOiBTdG9yYWdlU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWNlbnREYXRhU2VydmljZTogUmVjZW50RGF0YVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZW50aXR5RGV2aWNlU2VydmljZTogRW50aXR5RGV2aWNlU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBwYXJhbWV0ZXJTZXJ2aWNlOiBQYXJhbWV0ZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgICAgICBwdWJsaWMgZGF0ZVNlcnZpY2U6IERhdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHRyZW5kU2VydmljZTogVHJlbmRTZXJ2aWNlXG4gICAgKSB7IH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLm9yZ0lEID0gdGhpcy5zdG9yYWdlU2VydmljZS5nZXRTdG9yYWdlKCdjdXJyZW50T3JnSUQnKTtcbiAgICAgICAgdGhpcy50aW1lem9uZSA9IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0U3RvcmFnZSgndGltZXpvbmUnKTtcbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbktleUlEID0gdGhpcy5zdG9yYWdlU2VydmljZS5nZXRTdG9yYWdlKCdhcHBsaWNhdGlvbktleUlEJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuYXBwbGljYXRpb25LZXlJRCA9PSBBcHBsaWNhdGlvbktleUlELkVORVJHWV9LRVlfSUQpIHtcbiAgICAgICAgICAgIHRoaXMucGFyYW1NZXRyaWMgPSBcImVuZ0VuZXJneVVzZWRcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmFwcGxpY2F0aW9uS2V5SUQgPT0gQXBwbGljYXRpb25LZXlJRC5XQVRFUl9LRVlfSUQpIHtcbiAgICAgICAgICAgIHRoaXMucGFyYW1NZXRyaWMgPSBcImd3Rmxvd1RvdGFsaXplclwiO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXREZXZpY2VzV2l0aEVudGl0aWVzQnlQYXJhbWV0ZXIoKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXREZXZpY2VzV2l0aEVudGl0aWVzQnlQYXJhbWV0ZXIoKSB7XG4gICAgICAgIHRoaXMuZW50aXR5RGV2aWNlTSA9IDxEZXZpY2VzV2l0aEVudGl0aWVzTVtdPmF3YWl0IHRoaXMuZW50aXR5RGV2aWNlU2VydmljZS5nZXREZXZpY2VzV2l0aEVudGl0aWVzQnlQYXJhbWV0ZXIodGhpcy5vcmdJRCwgdGhpcy5wYXJhbU1ldHJpYyk7XG5cbiAgICAgICAgdGhpcy5tZXRlclNlYXJjaFV0aWwuZW50aXR5QXJyID0gdGhpcy5lbnRpdHlEZXZpY2VNO1xuICAgICAgICB0aGlzLm1ldGVyU2VhcmNoVXRpbC5jcmVhdGVTdWJzY3JpcHRpb24oKTtcblxuICAgICAgICBpZiAodGhpcy5lbnRpdHlEZXZpY2VNLmxlbmd0aCA+IDAgJiYgdGhpcy5lbnRpdHlEZXZpY2VNPy5bMF0/LmlkKSB7XG4gICAgICAgICAgICBjb25zdCBkZXZpY2VJRCA9IHRoaXMuZW50aXR5RGV2aWNlTT8uWzBdPy5bJ2RldmljZXMnXT8uWzBdPy5bJ2lkJ107XG4gICAgICAgICAgICB0aGlzLm1ldGVyRkMucGF0Y2hWYWx1ZShkZXZpY2VJRCk7XG5cbiAgICAgICAgICAgIHRoaXMuZ2V0UGFyYW1ldGVyTGlzdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbWV0ZXJDaGFuZ2Uoc2VsZWN0ZWRNZXRlcikge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5hcGlUaW1lcik7XG4gICAgICAgIHRoaXMuc2hvd0xvYWRlciA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5tZXRlckZDLnBhdGNoVmFsdWUoc2VsZWN0ZWRNZXRlcik7XG4gICAgICAgIHRoaXMuZ2V0UGFyYW1ldGVyTGlzdCgpO1xuICAgIH1cblxuICAgIGdldFBhcmFtZXRlckxpc3QoKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkTWV0ZXIgPSB0aGlzLm1ldGVyRkMudmFsdWU7XG4gICAgICAgIHRoaXMuZ2V0UGFyYW1ldGVyQnlEZXZpY2VJRChzZWxlY3RlZE1ldGVyKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRQYXJhbWV0ZXJCeURldmljZUlEKGRldmljZUlEKSB7XG4gICAgICAgIGxldCByZXF1ZXN0Qm9keSA9IHt9O1xuICAgICAgICByZXF1ZXN0Qm9keVsnZGV2aWNlSUQnXSA9IFtkZXZpY2VJRF07XG5cbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJNID0gPFBhcmFtZXRlck1bXT5hd2FpdCB0aGlzLnBhcmFtZXRlclNlcnZpY2UuZ2V0UGFyYW1ldGVyQnlEZXZpY2VJRCh0aGlzLm9yZ0lELCByZXF1ZXN0Qm9keSk7XG5cbiAgICAgICAgaWYgKHRoaXMucGFyYW1ldGVyTS5sZW5ndGggPiAwICYmIHRoaXMucGFyYW1ldGVyTT8uWzBdPy5pZCkge1xuICAgICAgICAgICAgdGhpcy5nZXRSZWNlbnRNZXRlckRhdGEoZGV2aWNlSUQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0UmVjZW50TWV0ZXJEYXRhKGRldmljZUlEKSB7XG5cbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UucmVzZXRBbGVydFByb3BlcnRpZXModGhpcy5hbGVydE9iaik7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCByZXF1ZXN0RGF0YSA9IG5ldyBSZWNlbnREYXRhUmVxdWVzdFdpdGhQYXJhbSgpO1xuXG4gICAgICAgICAgICByZXF1ZXN0RGF0YS5wYXJhbXMgPSB0aGlzLnBhcmFtZXRlck0ubWFwKHBhcmFtID0+ICh7IG5hbWU6IHBhcmFtLnBhcmFtTWV0cmljIH0pKTtcbiAgICAgICAgICAgIHJlcXVlc3REYXRhLmRldmljZUlEID0gW2RldmljZUlEXTtcbiAgICAgICAgICAgIHJlcXVlc3REYXRhLmJhY2tzY2FuID0gMTtcbiAgICAgICAgICAgIHJlcXVlc3REYXRhLnRpbWV6b25lID0gdGhpcy50aW1lem9uZTtcblxuICAgICAgICAgICAgdGhpcy5tZXRlckRhdGFSZXMgPSBhd2FpdCB0aGlzLnJlY2VudERhdGFTZXJ2aWNlLmdldFJlY2VudERhdGFXaXRoUGFyYW0odGhpcy5vcmdJRCwgcmVxdWVzdERhdGEpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5tZXRlckRhdGFSZXM/Lmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc2V0QWxlcnRQcm9wZXJ0aWVzKHRoaXMuYWxlcnRPYmosIERhc2hib2FyZEVycm9yRW51bS5EQVRBX05PVF9GT1VORF9MQUJFTCwgRGFzaGJvYXJkRXJyb3JFbnVtLkRBVEFfTk9UX0ZPVU5EX01FU1NBR0UsIE1lc3NhZ2VBbGVydFR5cGVFbnVtLldBUk5JTkcsIE1lc3NhZ2VBbGVydEljb25FbnVtLldBUk5JTkdfSUNPTik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluIGdldFJlY2VudE1ldGVyRGF0YSgpYCwgZXJyb3IpO1xuICAgICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc2V0QWxlcnRQcm9wZXJ0aWVzKHRoaXMuYWxlcnRPYmosIERhc2hib2FyZEVycm9yRW51bS5JTlZBTElEX0VSUk9SX0xBQkVMLCBEYXNoYm9hcmRFcnJvckVudW0uSU5WQUxJRF9FUlJPUl9NRVNTQUdFLCBNZXNzYWdlQWxlcnRUeXBlRW51bS5EQU5HRVIsIE1lc3NhZ2VBbGVydEljb25FbnVtLkRBTkdFUl9JQ09OKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHRoaXMuYXBpVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFJlY2VudE1ldGVyRGF0YShkZXZpY2VJRCk7XG4gICAgICAgICAgICB9LCAzMDAwMDApO1xuICAgICAgICAgICAgdGhpcy5zaG93TG9hZGVyID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXRMYXN0NDhIcnNNZXRlckRhdGEocGFyYW1OYW1lKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgcmVxdWVzdERhdGEgPSBuZXcgUmVjZW50RGF0YVJlcXVlc3RXaXRoUGFyYW0oKTtcblxuICAgICAgICAgICAgcmVxdWVzdERhdGEucGFyYW1zID0gW3sgbmFtZTogcGFyYW1OYW1lIH1dO1xuICAgICAgICAgICAgcmVxdWVzdERhdGEuZGV2aWNlSUQgPSBbdGhpcy5tZXRlckZDLnZhbHVlXTtcbiAgICAgICAgICAgIHJlcXVlc3REYXRhLmJhY2tzY2FuID0gNDg7XG4gICAgICAgICAgICByZXF1ZXN0RGF0YS50aW1lem9uZSA9IHRoaXMudGltZXpvbmU7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVjZW50RGF0YVNlcnZpY2UuZ2V0UmVjZW50RGF0YVdpdGhQYXJhbSh0aGlzLm9yZ0lELCByZXF1ZXN0RGF0YSk7XG5cbiAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdDQ4SHJzTWV0ZXJEYXRhW3BhcmFtTmFtZV0gPSByZXN1bHRbMF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdDQ4SHJzTWV0ZXJEYXRhW3BhcmFtTmFtZV0gPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGFyYW1OYW1lID0gcGFyYW1OYW1lO1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBpbiBnZXRMYXN0NDhIcnNNZXRlckRhdGEoKWAsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNob3dUcmVuZChwYXJhbU1ldHJpYywgZW50aXR5SUQpIHtcbiAgICAgICAgbGV0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgICAgICAgcGFyYW1NZXRyaWM6IHBhcmFtTWV0cmljLFxuICAgICAgICAgICAgZW50aXR5SUQ6IGVudGl0eUlELFxuICAgICAgICAgICAgZGV2aWNlSUQ6IHRoaXMubWV0ZXJGQy52YWx1ZVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnRyZW5kU2VydmljZS5vcGVuRGlhbG9nKHJlcXVlc3RCb2R5KTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuYXBpVGltZXIpO1xuICAgIH1cblxufSIsIjxkaXYgY2xhc3M9XCJjYXJkIG1haW4tY2FyZCBjYXJkT3ZlcndyaXRlIGgxMDBcIj5cbiAgICA8ZGl2IGNsYXNzPVwiaGVhZGVyQ29udGFpbmVyXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJoZWFkZXJMZWZ0Q29udGFpbmVyXCI+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwicGFnZVRpdGxlXCI+TWV0ZXIgRGF0YSBEYXNoYm9hcmQ8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG5cbiAgICA8ZGl2IGNsYXNzPVwiY2FyZC1ib2R5XCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJyb3dcIj5cbiAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtc20tM1wiPlxuICAgICAgICAgICAgICAgIDxtYXQtZm9ybS1maWVsZCBjbGFzcz1cIm1hdEZpZWxkV2lkdGgxMDBcIlxuICAgICAgICAgICAgICAgICAgICBbYXBwZWFyYW5jZV09XCJNYXRlcmlhbEZvcm1GaWVsZEFwcGVhcmFuY2UuRk9STV9GSUVMRF9BUFBFQVJBTkNFXCI+XG4gICAgICAgICAgICAgICAgICAgIDxtYXQtbGFiZWw+U2VsZWN0IG1ldGVyPC9tYXQtbGFiZWw+XG4gICAgICAgICAgICAgICAgICAgIDxtYXQtc2VsZWN0IChzZWxlY3Rpb25DaGFuZ2UpPVwibWV0ZXJDaGFuZ2UoJGV2ZW50LnZhbHVlKVwiIFtmb3JtQ29udHJvbF09XCJtZXRlckZDXCIgcmVxdWlyZWQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKm5nSWY9XCJlbnRpdHlEZXZpY2VNICYmIGVudGl0eURldmljZU0ubGVuZ3RoID4gMCAmJiBlbnRpdHlEZXZpY2VNPy5bMF0/LmlkOyBlbHNlIG5vRGF0YUZvdW5kXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPG1hdC1vcHRpb24+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxuZ3gtbWF0LXNlbGVjdC1zZWFyY2ggW2Zvcm1Db250cm9sXT1cIm1ldGVyU2VhcmNoVXRpbC5maWx0ZXJGQ1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlckxhYmVsPVwiU2VhcmNoIGJ5IGVudGl0eSBuYW1lXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vRW50cmllc0ZvdW5kTGFiZWw9XCJObyBtYXRjaGluZyBuYW1lIGZvdW5kLlwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L25neC1tYXQtc2VsZWN0LXNlYXJjaD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L21hdC1vcHRpb24+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPG1hdC1vcHRncm91cCAqbmdGb3I9XCJsZXQgZW50aXR5IG9mIG1ldGVyU2VhcmNoVXRpbC5maWx0ZXJlZEVudGl0aWVzIHwgYXN5bmNcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbbGFiZWxdPVwiZW50aXR5Lm5hbWVcIiBbZGlzYWJsZWRdPVwiZW50aXR5LmRpc2FibGVkXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxtYXQtb3B0aW9uICpuZ0Zvcj1cImxldCBkZXZpY2Ugb2YgZW50aXR5LmRldmljZXNcIiBbdmFsdWVdPVwiZGV2aWNlLmlkXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7eyBkZXZpY2UubmFtZSB9fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L21hdC1vcHRpb24+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9tYXQtb3B0Z3JvdXA+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxuZy10ZW1wbGF0ZSAjbm9EYXRhRm91bmQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPG1hdC1vcHRpb24gZGlzYWJsZWQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt7IENPTU1PTl9DT05TVEFOVC5OT19EQVRBX0ZPVU5EIH19XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9tYXQtb3B0aW9uPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgICAgICAgICAgICAgPC9tYXQtc2VsZWN0PlxuICAgICAgICAgICAgICAgICAgICA8bWF0LWVycm9yICpuZ0lmPVwibWV0ZXJGQy50b3VjaGVkICYmIG1ldGVyRkMuaGFzRXJyb3IoJ3JlcXVpcmVkJylcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIHt7IEZvcm1FcnJvckVudW0uUkVRVUlSRUQgfX1cbiAgICAgICAgICAgICAgICAgICAgPC9tYXQtZXJyb3I+XG4gICAgICAgICAgICAgICAgPC9tYXQtZm9ybS1maWVsZD5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICA8ZGl2IGNsYXNzPVwicm93IG10LTJcIj5cbiAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtc20tMTJcIj5cbiAgICAgICAgICAgICAgICA8bGliLW1lc3NhZ2UtYWxlcnQgKm5nSWY9XCJhbGVydE9iai5zaG93QWxlcnRcIiBbbGFiZWxJbnBdPVwiYWxlcnRPYmouYWxlcnRMYWJlbFwiXG4gICAgICAgICAgICAgICAgICAgIFtjb250ZW50SW5wXT1cImFsZXJ0T2JqLmFsZXJ0Q29udGVudFwiIFttZXNzYWdlQWxlcnRUeXBlSW5wXT1cImFsZXJ0T2JqLm1lc3NhZ2VBbGVydFR5cGVcIlxuICAgICAgICAgICAgICAgICAgICBbbWVzc2FnZUFsZXJ0SWNvbklucF09XCJhbGVydE9iai5tZXNzYWdlQWxlcnRJY29uXCI+XG4gICAgICAgICAgICAgICAgPC9saWItbWVzc2FnZS1hbGVydD5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICA8ZGl2IGNsYXNzPVwicm93IG10LTJcIj5cbiAgICAgICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJzaG93TG9hZGVyOyBlbHNlIGRhdGFUZW1wbGF0ZVwiPlxuICAgICAgICAgICAgICAgIDxsaWItc2tlbGV0b24tbG9hZGVyIFtjb3VudF09XCIzXCIgW2FwcGVhcmFuY2VdPVwiJydcIlxuICAgICAgICAgICAgICAgICAgICBbdGhlbWVdPVwieyAnYm9yZGVyLXJhZGl1cyc6ICcxNnB4JywgaGVpZ2h0OiAnNDBweCcsICdiYWNrZ3JvdW5kLWNvbG9yJzogJ3JnYigyMzAgMjMyIDIzNSknIH1cIj48L2xpYi1za2VsZXRvbi1sb2FkZXI+XG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICAgIDxuZy10ZW1wbGF0ZSAjZGF0YVRlbXBsYXRlPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtc20tNCBtYi0zXCIgKm5nRm9yPVwibGV0IG1ldGVyRGF0YSBvZiBtZXRlckRhdGFSZXNcIj5cbiAgICAgICAgICAgICAgICAgICAgPG1hdC1jYXJkIGNsYXNzPVwiY2FyZE92ZXJ3cml0ZSBjYXJkQmFja2dyb3VuZENvbG9yXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ1RlbXBsYXRlT3V0bGV0PVwicGFyYW1ldGVyRGF0YTsgY29udGV4dDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBsYXN0NDhIcnNNZXRlckRhdGEgJiYgbGFzdDQ4SHJzTWV0ZXJEYXRhW21ldGVyRGF0YS5wYXJhbU5hbWVdPy5kYXRhPy5kYXRlID8gZGF0ZVNlcnZpY2UuZ2V0UmVsYXRpdmVUaW1lQWdvTGFiZWwobGFzdDQ4SHJzTWV0ZXJEYXRhW21ldGVyRGF0YS5wYXJhbU5hbWVdPy5kYXRhPy5kYXRlLCB0aW1lem9uZSkgOiBkYXRlU2VydmljZS5nZXRSZWxhdGl2ZVRpbWVBZ29MYWJlbChtZXRlckRhdGE/LmRhdGE/LmRhdGUsIHRpbWV6b25lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGFzdDQ4SHJzTWV0ZXJEYXRhICYmIGxhc3Q0OEhyc01ldGVyRGF0YVttZXRlckRhdGEucGFyYW1OYW1lXT8uZGF0YT8udmFsdWUgIT0gbnVsbCA/IGxhc3Q0OEhyc01ldGVyRGF0YVttZXRlckRhdGEucGFyYW1OYW1lXT8uZGF0YT8udmFsdWUgOiBtZXRlckRhdGE/LmRhdGE/LnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXQ6IG1ldGVyRGF0YT8udW5pdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbWV0ZXJEYXRhPy5wYXJhbUxhYmVsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eUlEOiBtZXRlckRhdGE/LmVudGl0eUlELFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtTmFtZTogbWV0ZXJEYXRhPy5wYXJhbU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBtZXRlckRhdGE/LnN0YXR1c1xuICAgICAgICAgICAgICAgICAgICAgICAgfVwiPjwvbmctY29udGFpbmVyPlxuICAgICAgICAgICAgICAgICAgICA8L21hdC1jYXJkPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgPC9kaXY+XG5cbiAgICA8L2Rpdj5cbjwvZGl2PlxuXG48bmctdGVtcGxhdGUgI3BhcmFtZXRlckRhdGEgbGV0LWR1cmF0aW9uPVwiZHVyYXRpb25cIiBsZXQtbGFiZWw9XCJsYWJlbFwiIGxldC12YWx1ZT1cInZhbHVlXCIgbGV0LXVuaXQ9XCJ1bml0XCJcbiAgICBsZXQtZW50aXR5SUQ9XCJlbnRpdHlJRFwiIGxldC1wYXJhbU5hbWU9XCJwYXJhbU5hbWVcIiBsZXQtc3RhdHVzPVwic3RhdHVzXCI+XG4gICAgPGRpdiBjbGFzcz1cInJvd1wiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY29sLXNtLTYgdGV4dER1cmF0aW9uV2l0aEFnb1RpbWVcIj5cbiAgICAgICAgICAgIHt7IGR1cmF0aW9uIH19XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwiY29sLXNtLTYgdGV4dC1lbmRcIj5cbiAgICAgICAgICAgIDxhICpuZ0lmPVwic3RhdHVzID09ICdPRkZMSU5FJ1wiIGNsYXNzPVwidGV4dC1zZWNvbmRhcnkgY3Vyc29yUG9pbnRlciBtZS0yXCJcbiAgICAgICAgICAgICAgICBtYXRUb29sdGlwPVwiQ3VycmVudGx5IHBhcmFtZXRlciBpcyBvZmZsaW5lLCBjbGljayBoZXJlIHRvIHNlZSBkYXRhIG9mIGxhc3QgNDggaHJzLlwiXG4gICAgICAgICAgICAgICAgbWF0VG9vbHRpcFBvc2l0aW9uPVwiYmVsb3dcIiAoY2xpY2spPVwiZ2V0TGFzdDQ4SHJzTWV0ZXJEYXRhKHBhcmFtTmFtZSlcIj5cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cIm1hdGVyaWFsLXN5bWJvbHMtb3V0bGluZWQgZnMtNSBmdy1ib2xkXCI+ZGV2aWNlczwvc3Bhbj5cbiAgICAgICAgICAgIDwvYT5cbiAgICAgICAgICAgIDxhIGNsYXNzPVwidGV4dC1wcmltYXJ5IGN1cnNvclBvaW50ZXJcIiBtYXRUb29sdGlwPVwiVHJlbmRcIiBtYXRUb29sdGlwUG9zaXRpb249XCJiZWxvd1wiXG4gICAgICAgICAgICAgICAgKGNsaWNrKT1cInNob3dUcmVuZChwYXJhbU5hbWUsIGVudGl0eUlEKVwiPlxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwibWF0ZXJpYWwtc3ltYm9scy1vdXRsaW5lZCBmcy01IGZ3LWJvbGRcIj50cmVuZGluZ191cDwvc3Bhbj5cbiAgICAgICAgICAgIDwvYT5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cInJvdyBtdC0zXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtc20tMTIgdGV4dC1jZW50ZXJcIj5cbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwiZnMtMSBmdy1ib2xkIHRleHQtcHJpbWFyeVwiPnt7IHZhbHVlICE9IG51bGwgJiYgdmFsdWUgIT0gdW5kZWZpbmVkID8gKHZhbHVlIHwgbnVtYmVyOiAnMS4yLTInIHx8XG4gICAgICAgICAgICAgICAgQ09NTU9OX0NPTlNUQU5ULkhZUEhFTikgOiBDT01NT05fQ09OU1RBTlQuSFlQSEVOIH19PC9zcGFuPlxuICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJ0ZXh0LXNlY29uZGFyeSBmdy1ib2xkXCI+IHt7IHZhbHVlID8gdW5pdCA6ICcnIH19IDwvc3Bhbj5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cInJvdyBtdC00IG1iLTRcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImNvbC1zbS0xMiBmcy01IHRleHQtY2VudGVyXCI+XG4gICAgICAgICAgICB7eyBsYWJlbCB9fVxuICAgICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbjwvbmctdGVtcGxhdGU+Il19